<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f7f8fc; }
        .header-gradient { background-image: linear-gradient(135deg, #2a2a72 0%, #009ffd 100%); }
        .input-field {
            border-radius: 0.5rem; padding: 0.75rem 1rem; border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: #f9fafb;
        }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        .btn {
            border-radius: 0.5rem; transition: all 0.2s ease; color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary { background-image: linear-gradient(to right, #3b82f6, #60a5fa); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(59, 130, 246, 0.2); }
        .btn-secondary { background-image: linear-gradient(to right, #6b7280, #9ca3af); }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(107, 114, 128, 0.2); }
        .btn-success { background-image: linear-gradient(to right, #16a34a, #22c55e); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(22, 163, 74, 0.2); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th { background-color: #f3f4f6; }
        .tab-button {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #e0e7ff; color: #4338ca; border-color: #a5b4fc;
        }
        .tab-button:not(.active) { color: #4b5563; background-color: #f9fafb; }
        #admin-section { display: none; } /* Hide admin by default */
        .gemini-feedback-card {
            background: linear-gradient(145deg, #fffde7, #fff8e1);
            border-left: 5px solid #ffab00;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>
    
    <div id="message-box" class="fixed top-5 right-5 z-50 w-80"></div>
    <div id="modal-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"></div>

    <!-- NEW: Personalized Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="gemini-feedback-card p-6 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="feedback-card">
            <h3 class="text-xl font-bold text-yellow-800 mb-4 flex items-center">
                <i class="fas fa-sparkles mr-2 text-2xl"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏ä AI
            </h3>
            <div id="feedback-content" class="text-gray-700 space-y-3 leading-relaxed text-base">
                <!-- LLM generated content goes here -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-feedback-modal" class="btn btn-primary text-sm">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
    <!-- END NEW: Personalized Feedback Modal -->


    <!-- New Top Banner for the family phrase -->
    <div class="max-w-7xl mx-auto text-center py-3 mb-4 bg-pink-100 rounded-xl shadow-md border-2 border-pink-300">
        <h2 class="text-2xl font-extrabold text-pink-700 tracking-wider">
            ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ ‚ù§Ô∏è ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
        </h2>
    </div>
    <!-- End New Top Banner -->

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <header class="text-center p-8 sm:p-10 header-gradient relative">
            <!-- Back to Home Button (Visible when not on the form view) -->
            <button id="back-to-form-btn" class="absolute top-4 left-4 btn btn-secondary text-sm hidden" onclick="switchView('form')">
                <i class="fas fa-arrow-left mr-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white leading-tight">
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
            </h1>
            <p class="text-lg text-blue-200 mt-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</p>
        </header>

        <main class="p-6 sm:p-8">
            <!-- Navigation Tabs -->
            <div class="flex justify-center border-b mb-8 space-x-2 sm:space-x-4">
                <button id="tab-form" class="tab-button active" onclick="switchView('form')"><i class="fas fa-edit mr-2"></i>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="tab-results" class="tab-button" onclick="switchView('results')"><i class="fas fa-chart-bar mr-2"></i>‡∏î‡∏π‡∏ú‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à</button>
            </div>

            <!-- Form Section -->
            <div id="form-section">
                <form id="survey-form" class="space-y-8 max-w-2xl mx-auto">
                    <div>
                        <label for="nickname" class="block text-gray-700 font-semibold mb-2">
                            ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ô‡∏≤‡∏°‡πÅ‡∏ù‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                        </label>
                        <input type="text" id="nickname" class="input-field w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="curriculum" class="block text-gray-700 font-semibold mb-2">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</label>
                            <select id="curriculum" class="input-field w-full" required>
                                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ --</option>
                                <option value="EP">EP</option>
                                <option value="GM">GM</option>
                                <option value="SMTE">SMTE</option>
                                <option value="Normal">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                        </div>
                        <div>
                            <label for="examType" class="block text-gray-700 font-semibold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</label>
                            <select id="examType" class="input-field w-full" required>
                                <option value="On-site">On-site</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Score Inputs -->
                    <div id="score-inputs" class="space-y-4 pt-4 border-t">
                        <h3 class="font-semibold text-lg text-gray-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- JS will generate score fields here -->
                        </div>
                    </div>
                    
                    <div class="text-center pt-6">
                        <button type="submit" class="btn btn-primary w-full md:w-auto text-lg">
                            <i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
               <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <select id="filter-curriculum" class="input-field w-full">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</option>
                        <option value="EP">EP</option>
                        <option value="GM">GM</option>
                        <option value="SMTE">SMTE</option>
                        <option value="Normal">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                    </select>
                    <select id="filter-examType" class="input-field w-full">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</option>
                        <option value="On-site">On-site</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
                <div class="table-container border rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase">
                            <tr>
                                <th scope="col" class="py-3 px-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th scope="col" class="py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th scope="col" class="py-3 px-4">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</th>
                                <th scope="col" class="py-3 px-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≠‡∏ö</th>
                                <th scope="col" class="py-3 px-4 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <tr><td colspan="5" class="text-center py-6 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
             <!-- Admin Section -->
            <div id="admin-section" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Panel - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="export-csv" class="btn btn-success"><i class="fas fa-file-excel mr-2"></i>Export to CSV</button>
                    <button id="generate-analysis" class="btn text-white font-semibold rounded-lg" style="background-image: linear-gradient(to right, #f59e0b, #facc15);" onclick="generateOverallAnalysis()">
                        <i class="fas fa-brain mr-2"></i> ‚ú® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (AI)
                    </button>
                </div>
                
                <div id="analysis-output" class="hidden bg-yellow-50 border border-yellow-300 p-4 rounded-lg mb-6 text-gray-800">
                    <h3 class="font-bold text-lg mb-2 text-yellow-700 flex items-center"><i class="fas fa-chart-line mr-2"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI</h3>
                    <p id="analysis-content">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</p>
                </div>

                <div class="table-container border rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead id="admin-table-head" class="text-xs text-gray-700 uppercase">
                            <!-- Admin headers here -->
                        </thead>
                        <tbody id="admin-table-body">
                            <!-- Admin data here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
    
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Developed for Satriwitthaya Pre-test Takers</p>
        <a href="#" id="admin-login" class="text-blue-600 hover:underline">Admin Login</a>
    </footer>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Firebase Configuration ---
        // üö® UPDATE: Firebase Config JSON Object ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Firebase Console ‡∏ñ‡∏π‡∏Å‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
        const externalConfigJson = '{"apiKey":"AIzaSyAArg_514dJWcc73vHG-a1ngSxa4e_Kw1Y","authDomain":"satriwit-pretest-2569.firebaseapp.com","projectId":"satriwit-pretest-2569","storageBucket":"satriwit-pretest-2569.firebasestorage.app","messagingSenderId":"474635724481","appId":"1:474635724481:web:b236a9a88b47bcdd5c1640","measurementId":"G-9CD7MKHG7K"}'; 

        let firebaseConfig;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Config ‡∏à‡∏≤‡∏Å Canvas (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) { firebaseConfig = {}; }
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Config ‡∏ó‡∏µ‡πà hardcode ‡πÉ‡∏ô externalConfigJson (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Canvas)
        if (!firebaseConfig?.projectId) {
            try { firebaseConfig = JSON.parse(externalConfigJson); } catch(e) { firebaseConfig = {}; }
        }

        // --- Gemini API Configuration ---
        // üö® ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gemini (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ API Key ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 3;


        // --- Global Variables ---
        let db;
        let auth;
        let allScores = []; // Cache for all scores from Firestore
        const adminPassword = "@E12345@e"; 

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        const subjectConfig = {
            Special: [
                { name: 'Math', max: 50 }, 
                { name: 'Science', max: 30 }, 
                { name: 'English', max: 30 }
            ],
            Normal: [
                { name: 'Math', max: 30 }, 
                { name: 'Science', max: 30 }, 
                { name: 'English', max: 30 }, 
                { name: 'Thai', max: 30 }, 
                { name: 'Social', max: 30 }
            ]
        };
        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Header ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Admin/CSV
        const allSubjects = ['Math', 'Science', 'English', 'Thai', 'Social'];


        // --- UI Element References ---
        const curriculumSelect = document.getElementById('curriculum');
        const scoreInputsDiv = document.getElementById('score-inputs').querySelector('div');
        const form = document.getElementById('survey-form');
        const filterCurriculum = document.getElementById('filter-curriculum');
        const filterExamType = document.getElementById('filter-examType');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackCard = document.getElementById('feedback-card');
        
        // --- Core Functions ---
        
        // Initialize Firebase and Auth
        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Config ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "error");
                document.getElementById('results-table-body').innerHTML = `<tr><td colspan="5" class="text-center py-6 text-red-500">Firebase Config ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤.</td></tr>`;
                return; 
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                console.log("Firebase initialized and user signed in anonymously.");
                fetchAndDisplayScores();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
            }
        }

        // Custom Modal for confirmations/prompts (replacing alert/prompt)
        function customPrompt(message, callback) {
            const modalBox = document.getElementById('modal-box');
            modalBox.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-80">
                    <p class="text-lg font-medium text-gray-800 mb-4">${message}</p>
                    <input type="password" id="modal-input" class="input-field w-full mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" autocomplete="off">
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="btn btn-secondary text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button id="modal-confirm" class="btn btn-primary text-sm">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </div>
            `;
            modalBox.classList.remove('hidden');
            modalBox.classList.add('flex');

            document.getElementById('modal-confirm').onclick = () => {
                const password = document.getElementById('modal-input').value;
                modalBox.classList.add('hidden');
                modalBox.classList.remove('flex');
                callback(password);
            };

            document.getElementById('modal-cancel').onclick = () => {
                modalBox.classList.add('hidden');
                modalBox.classList.remove('flex');
                callback(null);
            };
            document.getElementById('modal-input').focus();
        }

        // Switch between Form, Results, and Admin view
        window.switchView = (view) => {
            const formSection = document.getElementById('form-section');
            const resultsSection = document.getElementById('results-section');
            const adminSection = document.getElementById('admin-section');
            const tabForm = document.getElementById('tab-form');
            const tabResults = document.getElementById('tab-results');
            const backBtn = document.getElementById('back-to-form-btn');

            // Hide all
            formSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            adminSection.classList.add('hidden');
            tabForm.classList.remove('active');
            tabResults.classList.remove('active');
            backBtn.classList.add('hidden');

            // Show selected view
            if(view === 'form') {
                formSection.classList.remove('hidden');
                tabForm.classList.add('active');
            } else if (view === 'results') {
                resultsSection.classList.remove('hidden');
                tabResults.classList.add('active');
                backBtn.classList.remove('hidden');
                applyFilters();
            } else if (view === 'admin') {
                adminSection.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                renderAdminTable(allScores);
            }
        };
        
        // Generate score input fields based on curriculum (UPDATED)
        function updateScoreInputs() {
            const selectedCurriculum = curriculumSelect.value;
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
            const type = (selectedCurriculum === 'Normal' || selectedCurriculum === 'EP' || selectedCurriculum === 'GM' || selectedCurriculum === 'SMTE') ? 'Normal' : 'Special';
             // ‡πÉ‡∏´‡πâ GM, SMTE, EP ‡πÉ‡∏ä‡πâ config Special
            const configKey = (selectedCurriculum === 'Normal') ? 'Normal' : 'Special';
            // subjects ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Object ‡∏ó‡∏µ‡πà‡∏°‡∏µ {name, max}
            const subjects = subjectConfig[configKey] || subjectConfig['Special']; // Default to special if ambiguous
            
            scoreInputsDiv.innerHTML = ''; // Clear previous fields
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Field Input ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î Max Score ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            subjects.forEach(subject => {
                const inputDiv = document.createElement('div');
                inputDiv.innerHTML = `
                    <label for="score_${subject.name}" class="block text-gray-700 text-sm font-medium mb-1">${subject.name} (‡πÄ‡∏ï‡πá‡∏° ${subject.max})</label>
                    <input type="number" id="score_${subject.name}" data-subject="${subject.name}" class="input-field w-full" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" required min="0" max="${subject.max}" step="0.01">
                `;
                scoreInputsDiv.appendChild(inputDiv);
            });
            
            // Add Rank input field
            const rankDiv = document.createElement('div');
            rankDiv.innerHTML = `
                <label for="rank" class="block text-gray-700 text-sm font-medium mb-1">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</label>
                <input type="number" id="rank" class="input-field w-full" placeholder="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ" required min="1">
            `;
            scoreInputsDiv.appendChild(rankDiv);
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            toggleLoading(true);
            
            if (!db) {
                showMessage("‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "error");
                toggleLoading(false);
                return;
            }

            const scores = {};
            let totalScore = 0;
            let isValid = true;
            let subjectScoresString = [];
            const selectedCurriculum = document.getElementById('curriculum').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            document.querySelectorAll('#score-inputs input[data-subject]').forEach(input => {
                const score = parseFloat(input.value);
                const max = parseFloat(input.max);

                if (score > max) {
                    showMessage(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${input.dataset.subject} ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${max}`, 'error');
                    isValid = false;
                }
                
                scores[input.dataset.subject] = score;
                totalScore += score;
                subjectScoresString.push(`${input.dataset.subject}: ${score}/${max}`);
            });
            
            const rank = parseInt(document.getElementById('rank').value);

            if (!isValid) {
                toggleLoading(false);
                return;
            }


            const nicknameInput = document.getElementById('nickname').value.trim();
            
            const submissionData = {
                // ‡∏ñ‡πâ‡∏≤ nickname ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ '‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å‡∏ô‡∏≤‡∏°' ‡πÅ‡∏ó‡∏ô
                nickname: nicknameInput || '‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å‡∏ô‡∏≤‡∏°',
                curriculum: selectedCurriculum,
                examType: document.getElementById('examType').value,
                rank: rank,
                scores: scores,
                totalScore: totalScore,
                createdAt: new Date()
            };

            try {
                // ‡πÉ‡∏ä‡πâ collection ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Public Data ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `artifacts/${appId}/public/data/scores_2569`;

                await addDoc(collection(db, collectionPath), submissionData);
                
                // 1. UPDATED Success Message
                showMessage("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• üôè", "success");
                form.reset();
                updateScoreInputs();
                switchView('results'); 

                // 2. Call Gemini for Personalized Feedback (Async)
                generateFeedback({
                    nickname: submissionData.nickname,
                    curriculum: submissionData.curriculum,
                    totalScore: submissionData.totalScore,
                    rank: submissionData.rank,
                    subjectScores: subjectScoresString.join(', ')
                });


            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞ Security Rules", "error");
            } finally {
                toggleLoading(false);
            }
        }
        
        // Fetch data from Firestore in real-time
        function fetchAndDisplayScores() {
            if (!db) return; // Prevent run if db is not initialized
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/scores_2569`;
            
            const scoresCollection = collection(db, collectionPath);
            const q = query(scoresCollection);

            onSnapshot(q, (querySnapshot) => {
                allScores = [];
                querySnapshot.forEach((doc) => {
                    allScores.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by Rank ascending (asc) in memory
                allScores.sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity));
                
                applyFilters(); // Re-render public table with new data
                if(document.getElementById('admin-section').classList.contains('hidden') === false) {
                    renderAdminTable(allScores);
                }
            }, (error) => {
                console.error("Error fetching scores: ", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
            });
        }
        
        // Filter and render the public results table
        function applyFilters() {
            const curriculum = filterCurriculum.value;
            const examType = filterExamType.value;
            
            const filteredScores = allScores.filter(score => {
                const curriculumMatch = curriculum === 'all' || score.curriculum === curriculum;
                const examTypeMatch = examType === 'all' || score.examType === examType;
                return curriculumMatch && examTypeMatch;
            });

            renderScoresTable(filteredScores);
        }

        function renderScoresTable(scores) {
            const tableBody = document.getElementById('results-table-body');
            if (scores.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = scores.map(score => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-bold text-gray-900">${score.rank}</td>
                    <td class="py-3 px-4">${score.nickname}</td>
                    <td class="py-3 px-4">${score.curriculum}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${score.examType === 'On-site' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${score.examType}</span></td>
                    <td class="py-3 px-4 text-right font-bold text-blue-600">${(score.totalScore || 0).toFixed(2)}</td>
                </tr>
            `).join('');
        }
        
        // --- Gemini LLM Functions ---
        async function makeGeminiApiCall(userQuery, systemInstruction) {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] },
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";
                    return text;

                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) {
                        console.error("Gemini API call failed after max retries:", error);
                        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generateFeedback(data) {
            toggleLoading(true);
            
            const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ä‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏°.1 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå. ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à.
            
            ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:
            1. ‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô.
            2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£, ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°, ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö, ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤)
            3. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©, ‡∏Ñ‡∏ß‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£, ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£) ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ.
            4. ‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏™‡∏±‡πâ‡∏ô‡πÜ.
            5. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Markdown (H1, H2) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö Bullet/Number (ul, ol) ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡∏ô. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5-7 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ.`;

            const userQuery = `‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏õ‡∏µ 2569:
            - ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô/‡∏ô‡∏≤‡∏°‡πÅ‡∏ù‡∏á: ${data.nickname}
            - ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${data.curriculum}
            - ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${data.totalScore.toFixed(2)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            - ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ${data.rank}
            - ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤: ${data.subjectScores}
            
            ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏â‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢`;

            const feedback = await makeGeminiApiCall(userQuery, systemPrompt);
            
            document.getElementById('feedback-content').innerHTML = feedback.replace(/\n/g, '<br>');
            showFeedbackModal();
            toggleLoading(false);
        }

        async function generateOverallAnalysis() {
            if (allScores.length < 5) {
                showMessage("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ä‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°", "warning");
                return;
            }

            toggleLoading(true);
            document.getElementById('analysis-output').classList.remove('hidden');
            document.getElementById('analysis-content').innerHTML = `<div class="flex items-center text-blue-600"><div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-blue-500 mr-3"></div> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;

            const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏°.1 ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤. ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.
            
            ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:
            1. ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î, ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì).
            2. ‡∏ä‡∏µ‡πâ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á/‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏î‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©).
            3. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° (‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•).
            4. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Markdown Headers. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6-8 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ.
            5. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON string.`;

            const dataToAnalyze = allScores.map(score => ({
                curriculum: score.curriculum,
                totalScore: score.totalScore,
                rank: score.rank,
                scores: score.scores,
                examType: score.examType
            }));

            const userQuery = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ: ${JSON.stringify(dataToAnalyze)}`;

            const analysis = await makeGeminiApiCall(userQuery, systemPrompt);

            document.getElementById('analysis-content').innerHTML = analysis.replace(/\n/g, '<br>');
            toggleLoading(false);
        }
        window.generateOverallAnalysis = generateOverallAnalysis; // Expose to HTML

        function showFeedbackModal() {
            feedbackModal.classList.remove('hidden');
            feedbackModal.classList.add('flex');
            setTimeout(() => {
                feedbackCard.classList.remove('scale-95', 'opacity-0');
                feedbackCard.classList.add('scale-100', 'opacity-100');
            }, 50);
        }

        document.getElementById('close-feedback-modal').onclick = () => {
            feedbackCard.classList.remove('scale-100', 'opacity-100');
            feedbackCard.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                feedbackModal.classList.add('hidden');
                feedbackModal.classList.remove('flex');
            }, 300);
        };
        // --- End Gemini LLM Functions ---
        
        // --- Admin Functions ---
        document.getElementById('admin-login').addEventListener('click', (e) => {
            e.preventDefault();
            customPrompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö:", (password) => {
                if (password === adminPassword) {
                    showMessage("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                    switchView('admin'); 
                } else if (password !== null) {
                    showMessage("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
                }
            });
        });

        function renderAdminTable(scores) {
            const tableHead = document.getElementById('admin-table-head');
            const tableBody = document.getElementById('admin-table-body');

            // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∏‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Header ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
            
            tableHead.innerHTML = `
                <tr>
                    <th class="py-3 px-4">Rank</th>
                    <th class="py-3 px-4">Nickname</th>
                    <th class="py-3 px-4">Curriculum</th>
                    <th class="py-3 px-4">Type</th>
                    ${allSubjects.map(s => `<th class="py-3 px-4 text-right">${s}</th>`).join('')}
                    <th class="py-3 px-4 text-right">Total</th>
                    <th class="py-3 px-4">Time Stamp</th>
                </tr>`;
            
            tableBody.innerHTML = scores.map(score => {
                const date = score.createdAt && score.createdAt.toDate ? score.createdAt.toDate() : (score.createdAt.seconds ? new Date(score.createdAt.seconds * 1000) : new Date());
                const timestamp = date.toLocaleString('th-TH');
                return `
                    <tr class="bg-white border-b">
                        <td class="py-3 px-4">${score.rank}</td>
                        <td class="py-3 px-4">${score.nickname}</td>
                        <td class="py-3 px-4">${score.curriculum}</td>
                        <td class="py-3 px-4">${score.examType}</td>
                        ${allSubjects.map(s => `<td class="py-3 px-4 text-right">${(score.scores && score.scores[s] !== undefined) ? score.scores[s].toFixed(2) : '-'}</td>`).join('')}
                        <td class="py-3 px-4 text-right font-bold">${(score.totalScore || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-xs">${timestamp}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM (Thai compatibility)
            
            const headers = ["Rank", "Nickname", "Curriculum", "ExamType", ...allSubjects, "TotalScore", "Timestamp"];
            csvContent += headers.join(",") + "\r\n";
            
            allScores.forEach(score => {
                const date = score.createdAt.toDate ? score.createdAt.toDate() : (score.createdAt.seconds ? new Date(score.createdAt.seconds * 1000) : new Date());
                const timestamp = date.toLocaleString('th-TH');
                
                const row = [
                    score.rank,
                    `"${score.nickname.replace(/"/g, '""')}"`, 
                    score.curriculum,
                    score.examType,
                    ...allSubjects.map(s => (score.scores && score.scores[s] !== undefined) ? score.scores[s] : '0'),
                    score.totalScore,
                    `"${timestamp}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "pretest_scores_2569.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
        }

        document.getElementById('export-csv').addEventListener('click', exportToCSV);


        // --- Helper Functions ---
        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            const colors = { success: 'green', error: 'red', warning: 'yellow' };
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 rounded-lg shadow-lg mb-2 bg-${colors[type]}-100 border-l-4 border-${colors[type]}-500 text-${colors[type]}-800 transition-all duration-300 transform translate-x-full opacity-0`;
            alertDiv.innerHTML = `<i class="fas ${icons[type]} mr-2"></i> <span class="font-semibold">${message}</span>`;
            
            box.prepend(alertDiv);
            setTimeout(() => alertDiv.classList.remove('translate-x-full', 'opacity-0'), 10);
            setTimeout(() => {
                alertDiv.classList.add('opacity-0');
                setTimeout(() => alertDiv.remove(), 400);
            }, 4000);
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            updateScoreInputs(); // Initial setup for score fields
        });
        curriculumSelect.addEventListener('change', updateScoreInputs);
        form.addEventListener('submit', handleFormSubmit);
        filterCurriculum.addEventListener('change', applyFilters);
        filterExamType.addEventListener('change', applyFilters);

    </script>
</body>
</html>
