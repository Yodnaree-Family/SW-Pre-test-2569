<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f7f8fc; }
        .header-gradient { background-image: linear-gradient(135deg, #2a2a72 0%, #009ffd 100%); }
        .input-field {
            border-radius: 0.5rem; padding: 0.75rem 1rem; border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: #f9fafb;
        }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        .btn {
            border-radius: 0.5rem; transition: all 0.2s ease; color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none; cursor: pointer;
        }
        .btn-primary { background-image: linear-gradient(to right, #3b82f6, #60a5fa); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(59, 130, 246, 0.2); }
        .btn-secondary { background-image: linear-gradient(to right, #6b7280, #9ca3af); }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(107, 114, 128, 0.2); }
        .btn-success { background-image: linear-gradient(to right, #16a34a, #22c55e); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(22, 163, 74, 0.2); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th { background-color: #f3f4f6; }
        .tab-button {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #e0e7ff; color: #4338ca; border-color: #a5b4fc;
        }
        .tab-button:not(.active) { color: #4b5563; background-color: #f9fafb; }
        #admin-section { display: none; } /* Hide admin by default */
    </style>
</head>
<body class="p-4 sm:p-6">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>
    
    <div id="message-box" class="fixed top-5 right-5 z-50 w-80"></div>
    <div id="modal-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"></div>

    <div class="max-w-7xl mx-auto text-center py-3 mb-4 bg-pink-100 rounded-xl shadow-md border-2 border-pink-300">
        <h2 class="text-2xl font-extrabold text-pink-700 tracking-wider">
            ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ ‚ù§Ô∏è ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
        </h2>
    </div>
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <header class="text-center p-8 sm:p-10 header-gradient relative">
            <!-- Back to form button for Admin/Results View -->
            <button id="back-to-form-btn" class="absolute top-4 left-4 btn btn-secondary text-sm hidden" onclick="switchView('form')">
                <i class="fas fa-arrow-left mr-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white leading-tight">
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
            </h1>
            <p class="text-lg text-blue-200 mt-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</p>
        </header>

        <main class="p-6 sm:p-8">
            <!-- Tabs -->
            <div class="flex justify-center border-b mb-8 space-x-2 sm:space-x-4">
                <button id="tab-form" class="tab-button active" onclick="switchView('form')"><i class="fas fa-edit mr-2"></i>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="tab-results" class="tab-button" onclick="switchView('results')"><i class="fas fa-chart-bar mr-2"></i>‡∏î‡∏π‡∏ú‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à</button>
            </div>

            <!-- Form Section -->
            <div id="form-section">
                <form id="survey-form" class="space-y-8 max-w-2xl mx-auto">
                    <div>
                        <label for="nickname" class="block text-gray-700 font-semibold mb-2">
                            ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ô‡∏≤‡∏°‡πÅ‡∏ù‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                        </label>
                        <input type="text" id="nickname" class="input-field w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="curriculum" class="block text-gray-700 font-semibold mb-2">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</label>
                            <select id="curriculum" class="input-field w-full" required>
                                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ --</option>
                                <option value="EP">EP</option>
                                <option value="GM">GM</option>
                                <option value="SMTE">SMTE</option>
                                <option value="Normal">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                        </div>
                        <div>
                            <label for="examType" class="block text-gray-700 font-semibold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</label>
                            <select id="examType" class="input-field w-full" required>
                                <option value="On-site">On-site</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Dynamic Score Inputs -->
                    <div id="score-inputs" class="space-y-4 pt-4 border-t">
                        <h3 class="font-semibold text-lg text-gray-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="text-center pt-6">
                        <button type="submit" class="btn btn-primary w-full md:w-auto text-lg">
                            <i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
               <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <select id="filter-curriculum" class="input-field w-full">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</option>
                        <option value="EP">EP</option>
                        <option value="GM">GM</option>
                        <option value="SMTE">SMTE</option>
                        <option value="Normal">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                    </select>
                    <select id="filter-examType" class="input-field w-full">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</option>
                        <option value="On-site">On-site</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
                <div class="table-container border rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase">
                            <tr>
                                <th scope="col" class="py-3 px-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th scope="col" class="py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th scope="col" class="py-3 px-4">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</th>
                                <th scope="col" class="py-3 px-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≠‡∏ö</th>
                                <th scope="col" class="py-3 px-4 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <tr><td colspan="5" class="text-center py-6 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Admin Section (Hidden by default) -->
            <div id="admin-section" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Panel - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <button id="export-csv" class="btn btn-success mb-6"><i class="fas fa-file-excel mr-2"></i>Export to CSV (Excel)</button>
                <div class="table-container border rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead id="admin-table-head" class="text-xs text-gray-700 uppercase">
                            <!-- Populated by JavaScript -->
                        </thead>
                        <tbody id="admin-table-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
    
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Developed for Satriwitthaya Pre-test Takers</p>
        <a href="#" id="admin-login" class="text-blue-600 hover:underline">Admin Login</a>
    </footer>
    
    <script type="module">
        // Updated imports to include signInWithCustomToken and removed unused orderBy
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Firebase Configuration ---
        const externalConfigJson = '{"apiKey": "AIzaSyAArg_514dJWcc73vHG-a1ngSxa4e_Kw1Y", "authDomain": "satriwit-pretest-2569.firebaseapp.com", "projectId": "satriwit-pretest-2569", "storageBucket": "satriwit-pretest-2569.firebasestorage.app", "messagingSenderId": "474635724481", "appId": "1:474635724481:web:b236a9a88b47bcdd5c1640", "measurementId": "G-9CD7MKHG7K"}';

        let firebaseConfig;
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á config ‡∏ú‡πà‡∏≤‡∏ô environment variable ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡πÉ‡∏ô Canvas)
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) { firebaseConfig = {}; }
        }
        
        // 2. ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ config ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏ö‡∏ô GitHub Pages/Local)
        if (!firebaseConfig?.projectId && externalConfigJson !== 'YOUR_FIREBASE_CONFIG_JSON_HERE') {
            try { firebaseConfig = JSON.parse(externalConfigJson); } catch(e) { firebaseConfig = {}; }
        }

        // --- Global Variables ---
        let db;
        let auth;
        let allScores = []; // Cache for all scores from Firestore
        const adminPassword = "@E12345@e"; 

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        const subjectConfig = {
            Special: [
                { name: 'Math', max: 50 }, 
                { name: 'Science', max: 30 }, 
                { name: 'English', max: 30 }
            ],
            Normal: [
                { name: 'Math', max: 30 }, 
                { name: 'Science', max: 30 }, 
                { name: 'English', max: 30 }, 
                { name: 'Thai', max: 30 }, 
                { name: 'Social', max: 30 }
            ]
        };
        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Header ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Admin/CSV
        const allSubjects = ['Math', 'Science', 'English', 'Thai', 'Social'];


        // --- UI Element References ---
        const curriculumSelect = document.getElementById('curriculum');
        const scoreInputsDiv = document.getElementById('score-inputs').querySelector('div');
        const form = document.getElementById('survey-form');
        const filterCurriculum = document.getElementById('filter-curriculum');
        const filterExamType = document.getElementById('filter-examType');
        
        // --- Core Functions ---
        
        // Initialize Firebase and Auth (Updated for Custom Token)
        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Config ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "error");
                document.getElementById('results-table-body').innerHTML = `<tr><td colspan="5" class="text-center py-6 text-red-500">Firebase Config ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤.</td></tr>`;
                return; 
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check for custom token, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Firebase signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Firebase signed in anonymously.");
                }

                fetchAndDisplayScores();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
            }
        }

        // Custom Modal for confirmations/prompts (replacing alert/prompt)
        function customPrompt(message, callback) {
            const modalBox = document.getElementById('modal-box');
            modalBox.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-80">
                    <p class="text-lg font-medium text-gray-800 mb-4">${message}</p>
                    <input type="password" id="modal-input" class="input-field w-full mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" autocomplete="off">
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="btn btn-secondary text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button id="modal-confirm" class="btn btn-primary text-sm">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </div>
            `;
            modalBox.classList.remove('hidden');
            modalBox.classList.add('flex');

            document.getElementById('modal-confirm').onclick = () => {
                const password = document.getElementById('modal-input').value;
                modalBox.classList.add('hidden');
                modalBox.classList.remove('flex');
                callback(password);
            };

            document.getElementById('modal-cancel').onclick = () => {
                modalBox.classList.add('hidden');
                modalBox.classList.remove('flex');
                callback(null);
            };
            document.getElementById('modal-input').focus();
        }

        // Switch between Form, Results, and Admin view
        window.switchView = (view) => {
            const formSection = document.getElementById('form-section');
            const resultsSection = document.getElementById('results-section');
            const adminSection = document.getElementById('admin-section');
            const tabForm = document.getElementById('tab-form');
            const tabResults = document.getElementById('tab-results');
            const backBtn = document.getElementById('back-to-form-btn'); // Added back button reference

            // Hide all
            formSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            adminSection.classList.add('hidden');
            tabForm.classList.remove('active');
            tabResults.classList.remove('active');
            backBtn.classList.add('hidden'); // Hide back button by default

            // Show selected view
            if(view === 'form') {
                formSection.classList.remove('hidden');
                tabForm.classList.add('active');
            } else if (view === 'results') {
                resultsSection.classList.remove('hidden');
                tabResults.classList.add('active');
                backBtn.classList.remove('hidden'); // Show back button
                applyFilters();
            } else if (view === 'admin') {
                adminSection.classList.remove('hidden');
                backBtn.classList.remove('hidden'); // Show back button
                // Do not mark a tab active for admin view
                renderAdminTable(allScores);
            }
        };
        
        // Generate score input fields based on curriculum
        function updateScoreInputs() {
            const selectedCurriculum = curriculumSelect.value;
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ (EP, GM, SMTE ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Special)
            const type = (selectedCurriculum === 'Normal') ? 'Normal' : 'Special';
            // subjects ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Object ‡∏ó‡∏µ‡πà‡∏°‡∏µ {name, max}
            const subjects = subjectConfig[type] || [];
            
            scoreInputsDiv.innerHTML = ''; // Clear previous fields
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Field Input ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î Max Score ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            subjects.forEach(subject => {
                const inputDiv = document.createElement('div');
                inputDiv.innerHTML = `
                    <label for="score_${subject.name}" class="block text-gray-700 text-sm font-medium mb-1">${subject.name} (‡πÄ‡∏ï‡πá‡∏° ${subject.max})</label>
                    <input type="number" id="score_${subject.name}" data-subject="${subject.name}" class="input-field w-full" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" required min="0" max="${subject.max}" step="0.01">
                `;
                scoreInputsDiv.appendChild(inputDiv);
            });
            
            // Add Rank input field
            const rankDiv = document.createElement('div');
            rankDiv.innerHTML = `
                <label for="rank" class="block text-gray-700 text-sm font-medium mb-1">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</label>
                <input type="number" id="rank" class="input-field w-full" placeholder="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ" required min="1">
            `;
            scoreInputsDiv.appendChild(rankDiv);
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            toggleLoading(true);
            
            if (!db) {
                showMessage("‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "error");
                toggleLoading(false);
                return;
            }

            const scores = {};
            let totalScore = 0;
            let isValid = true;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            document.querySelectorAll('#score-inputs input[data-subject]').forEach(input => {
                const score = parseFloat(input.value);
                const max = parseFloat(input.max);

                if (score > max) {
                    showMessage(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${input.dataset.subject} ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${max}`, 'error');
                    isValid = false;
                }
                
                scores[input.dataset.subject] = score;
                totalScore += score;
            });
            
            if (!isValid) {
                toggleLoading(false);
                return;
            }


            const nicknameInput = document.getElementById('nickname').value.trim();
            
            const submissionData = {
                // ‡∏ñ‡πâ‡∏≤ nickname ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ '‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å‡∏ô‡∏≤‡∏°' ‡πÅ‡∏ó‡∏ô
                nickname: nicknameInput || '‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å‡∏ô‡∏≤‡∏°',
                curriculum: document.getElementById('curriculum').value,
                examType: document.getElementById('examType').value,
                rank: parseInt(document.getElementById('rank').value),
                scores: scores,
                totalScore: totalScore,
                createdAt: new Date()
            };

            try {
                // ‡πÉ‡∏ä‡πâ collection ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Public Data ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `artifacts/${appId}/public/data/scores_2569`;

                await addDoc(collection(db, collectionPath), submissionData);
                // UPDATED Success Message
                showMessage("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• üôè‡∏´‡∏ß‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏¥‡πà‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô", "success");
                form.reset();
                updateScoreInputs();
                switchView('results'); // Switch to results after successful submission
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞ Security Rules", "error");
            } finally {
                toggleLoading(false);
            }
        }
        
        // Fetch data from Firestore in real-time
        function fetchAndDisplayScores() {
            if (!db) return; // Prevent run if db is not initialized
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/scores_2569`;
            
            const scoresCollection = collection(db, collectionPath);
            const q = query(scoresCollection);

            onSnapshot(q, (querySnapshot) => {
                allScores = [];
                querySnapshot.forEach((doc) => {
                    allScores.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by Rank ascending (asc) in memory to avoid Firestore index issues
                allScores.sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity));
                
                applyFilters(); // Re-render public table with new data
                if(document.getElementById('admin-section').style.display !== 'none') {
                    renderAdminTable(allScores);
                }
            }, (error) => {
                console.error("Error fetching scores: ", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
            });
        }
        
        // Filter and render the public results table
        function applyFilters() {
            const curriculum = filterCurriculum.value;
            const examType = filterExamType.value;
            
            const filteredScores = allScores.filter(score => {
                const curriculumMatch = curriculum === 'all' || score.curriculum === curriculum;
                const examTypeMatch = examType === 'all' || score.examType === examType;
                return curriculumMatch && examTypeMatch;
            });

            renderScoresTable(filteredScores);
        }

        function renderScoresTable(scores) {
            const tableBody = document.getElementById('results-table-body');
            if (scores.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = scores.map(score => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-bold text-gray-900">${score.rank}</td>
                    <td class="py-3 px-4">${score.nickname}</td>
                    <td class="py-3 px-4">${score.curriculum}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${score.examType === 'On-site' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${score.examType}</span></td>
                    <td class="py-3 px-4 text-right font-bold text-blue-600">${(score.totalScore || 0).toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // --- Admin Functions ---
        document.getElementById('admin-login').addEventListener('click', (e) => {
            e.preventDefault();
            customPrompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö:", (password) => {
                if (password === adminPassword) {
                    showMessage("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                    switchView('admin'); 
                } else if (password !== null) {
                    showMessage("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
                }
            });
        });

        function renderAdminTable(scores) {
            const tableHead = document.getElementById('admin-table-head');
            const tableBody = document.getElementById('admin-table-body');

            // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∏‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Header ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
            
            tableHead.innerHTML = `
                <tr>
                    <th class="py-3 px-4">Rank</th>
                    <th class="py-3 px-4">Nickname</th>
                    <th class="py-3 px-4">Curriculum</th>
                    <th class="py-3 px-4">Type</th>
                    ${allSubjects.map(s => `<th class="py-3 px-4 text-right">${s}</th>`).join('')}
                    <th class="py-3 px-4 text-right">Total</th>
                    <th class="py-3 px-4">Time Stamp</th>
                </tr>`;
            
            tableBody.innerHTML = scores.map(score => {
                const date = score.createdAt && score.createdAt.toDate ? score.createdAt.toDate() : (score.createdAt.seconds ? new Date(score.createdAt.seconds * 1000) : new Date());
                const timestamp = date.toLocaleString('th-TH');
                return `
                    <tr class="bg-white border-b">
                        <td class="py-3 px-4">${score.rank}</td>
                        <td class="py-3 px-4">${score.nickname}</td>
                        <td class="py-3 px-4">${score.curriculum}</td>
                        <td class="py-3 px-4">${score.examType}</td>
                        ${allSubjects.map(s => `<td class="py-3 px-4 text-right">${(score.scores && score.scores[s] !== undefined) ? score.scores[s].toFixed(2) : '-'}</td>`).join('')}
                        <td class="py-3 px-4 text-right font-bold">${(score.totalScore || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-xs">${timestamp}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM (Thai compatibility)
            
            const headers = ["Rank", "Nickname", "Curriculum", "ExamType", ...allSubjects, "TotalScore", "Timestamp"];
            csvContent += headers.join(",") + "\r\n";
            
            allScores.forEach(score => {
                const date = score.createdAt.toDate ? score.createdAt.toDate() : (score.createdAt.seconds ? new Date(score.createdAt.seconds * 1000) : new Date());
                const timestamp = date.toLocaleString('th-TH');
                
                const row = [
                    score.rank,
                    `"${score.nickname.replace(/"/g, '""')}"`, 
                    score.curriculum,
                    score.examType,
                    ...allSubjects.map(s => (score.scores && score.scores[s] !== undefined) ? score.scores[s] : '0'),
                    score.totalScore,
                    `"${timestamp}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "pretest_scores_2569.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
        }

        document.getElementById('export-csv').addEventListener('click', exportToCSV);


        // --- Helper Functions ---
        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            const colors = { success: 'green', error: 'red', warning: 'yellow' };
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 rounded-lg shadow-lg mb-2 bg-${colors[type]}-100 border-l-4 border-${colors[type]}-500 text-${colors[type]}-800 transition-all duration-300 transform translate-x-full opacity-0`;
            alertDiv.innerHTML = `<i class="fas ${icons[type]} mr-2"></i> <span class="font-semibold">${message}</span>`;
            
            box.prepend(alertDiv);
            setTimeout(() => alertDiv.classList.remove('translate-x-full', 'opacity-0'), 10);
            setTimeout(() => {
                alertDiv.classList.add('opacity-0');
                setTimeout(() => alertDiv.remove(), 400);
            }, 4000);
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            updateScoreInputs(); // Initial setup for score fields
        });
        curriculumSelect.addEventListener('change', updateScoreInputs);
        form.addEventListener('submit', handleFormSubmit);
        filterCurriculum.addEventListener('change', applyFilters);
        filterExamType.addEventListener('change', applyFilters);

    </script>
</body>
</html>
