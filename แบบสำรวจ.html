<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสำรวจและวิเคราะห์คะแนน Pre-test สตรีวิทยา 2569</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- เพิ่ม SheetJS สำหรับการ export Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #f7f8fc;
        }
        .header-gradient {
            background-image: linear-gradient(135deg, #2a2a72 0%, #009ffd 100%);
        }
        .input-field {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .btn {
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #3b82f6, #60a5fa);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(59, 130, 246, 0.2);
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #6b7280, #9ca3af);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(107, 114, 128, 0.2);
        }
        .btn-success {
            background-image: linear-gradient(to right, #16a34a, #22c55e);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(22, 163, 74, 0.2);
        }
        .btn-danger {
            background-image: linear-gradient(to right, #dc2626, #ef4444);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(220, 38, 38, 0.2);
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        th {
            background-color: #f3f4f6;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #a5b4fc;
        }
        .tab-button:not(.active) {
            color: #4b5563;
            background-color: #f9fafb;
        }
        .result-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .result-tab.active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #a5b4fc;
        }
        .result-tab:not(.active) {
            color: #4b5563;
            background-color: #f9fafb;
        }
        .exam-type-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .exam-type-tab.active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #a5b4fc;
        }
        .exam-type-tab:not(.active) {
            color: #4b5563;
            background-color: #f9fafb;
        }
        .curriculum-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .curriculum-option.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .curriculum-option input[type="radio"] {
            margin-right: 0.5rem;
        }
        .line-opc-section {
            background: linear-gradient(135deg, #06c755 0%, #00b34c 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            color: white;
            text-align: center;
            box-shadow: 0 10px 25px rgba(6, 199, 85, 0.2);
        }
        .line-opc-button {
            display: inline-flex;
            align-items: center;
            background: white;
            color: #06c755;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-weight: 600;
            text-decoration: none;
            margin-top: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .line-opc-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.15);
            color: #06c755;
        }
        .hidden {
            display: none;
        }
        .admin-panel {
            background: #f8f9fa;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .score-input-section {
            background: #f8f9fa;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .exam-type-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .exam-type-option.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>
    
    <div id="message-box" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
    
    <div id="modal-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"></div>
    
    <div class="max-w-7xl mx-auto text-center py-3 mb-4 bg-pink-100 rounded-xl shadow-md border-2 border-pink-300">
        <h2 class="text-2xl font-extrabold text-pink-700 tracking-wider">
            ครอบครัวยอดนารี ❤️ สตรีวิทยา
        </h2>
    </div>
    
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <header class="text-center p-8 sm:p-10 header-gradient relative">
            <button id="back-to-form-btn" class="absolute top-4 left-4 btn btn-secondary text-sm hidden" onclick="switchView('form')">
                <i class="fas fa-arrow-left mr-1"></i> กลับหน้ากรอกข้อมูล
            </button>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white leading-tight">
                ระบบสำรวจและวิเคราะห์คะแนน Pre-test สตรีวิทยา
            </h1>
            <p class="text-lg text-blue-200 mt-2">ปีการศึกษา 2569</p>
        </header>
        
        <main class="p-6 sm:p-8">
            <!-- Tabs -->
            <div class="flex flex-wrap justify-center border-b mb-8 space-x-2 sm:space-x-4">
                <button id="tab-form" class="tab-button active" onclick="switchView('form')"><i class="fas fa-edit mr-2"></i>กรอกข้อมูล</button>
                <button id="tab-results" class="tab-button" onclick="switchView('results')"><i class="fas fa-chart-bar mr-2"></i>ดูผลสำรวจรวม</button>
                <button id="tab-analysis" class="tab-button" onclick="switchView('analysis')"><i class="fas fa-calculator mr-2"></i>วิเคราะห์คะแนน</button>
                <button id="tab-admin" class="tab-button" onclick="switchView('admin')"><i class="fas fa-cog mr-2"></i>สำหรับ Admin</button>
            </div>
            
            <!-- Form Section -->
            <div id="form-section">
                <form id="survey-form" class="space-y-8 max-w-4xl mx-auto">
                    <!-- ชื่อเล่น -->
                    <div>
                        <label for="nickname" class="block text-gray-700 font-semibold mb-2">ชื่อเล่น / นามแฝง (ไม่บังคับ)</label>
                        <input type="text" id="nickname" class="input-field w-full" placeholder="เช่น น้องยอดนารี">
                    </div>
                    
                    <!-- ส่วนที่ 1: แบบสำรวจคะแนนสอบ Pre-test -->
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-800 mb-4">ส่วนที่ 1: แบบสำรวจคะแนนสอบ Pre-test</h3>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-3">เลือกหลักสูตรที่สอบ Pre-test</label>
                            <div class="space-y-3">
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="pretestCurriculum" value="special" class="mr-3" onchange="toggleExamTypeSelection()">
                                    <div>
                                        <span class="font-medium">ห้องเรียนพิเศษ</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 3 วิชา: คณิต 50 คะแนน, วิทย์ 30 คะแนน, English 30 คะแนน</p>
                                    </div>
                                </label>
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="pretestCurriculum" value="normal" class="mr-3" onchange="toggleExamTypeSelection()">
                                    <div>
                                        <span class="font-medium">ห้องเรียนปกติ</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 5 วิชา: คณิต 30, วิทย์ 30, English 30, ไทย 30, สังคม 30 คะแนน</p>
                                    </div>
                                </label>
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="pretestCurriculum" value="both" class="mr-3" onchange="toggleExamTypeSelection()">
                                    <div>
                                        <span class="font-medium">สอบทั้ง 2 หลักสูตร</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบทั้งห้องเรียนพิเศษและห้องเรียนปกติ</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- ส่วนเลือกประเภทการสอบ -->
                        <div id="exam-type-selection" class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-3">เลือกประเภทการสอบ</label>
                            <div class="space-y-3">
                                <!-- แสดงเมื่อเลือกห้องเรียนพิเศษ -->
                                <div id="special-exam-type" class="hidden">
                                    <label class="block text-gray-700 mb-2">ห้องเรียนพิเศษ</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <label class="exam-type-option flex items-center">
                                            <input type="radio" name="specialExamType" value="On-site" class="mr-3">
                                            <div>
                                                <span class="font-medium">On-site</span>
                                                <p class="text-sm text-gray-600 mt-1">สอบที่โรงเรียน</p>
                                            </div>
                                        </label>
                                        <label class="exam-type-option flex items-center">
                                            <input type="radio" name="specialExamType" value="Online" class="mr-3">
                                            <div>
                                                <span class="font-medium">Online</span>
                                                <p class="text-sm text-gray-600 mt-1">สอบออนไลน์</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- แสดงเมื่อเลือกห้องเรียนปกติ -->
                                <div id="normal-exam-type" class="hidden">
                                    <label class="block text-gray-700 mb-2">ห้องเรียนปกติ</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <label class="exam-type-option flex items-center">
                                            <input type="radio" name="normalExamType" value="On-site" class="mr-3">
                                            <div>
                                                <span class="font-medium">On-site</span>
                                                <p class="text-sm text-gray-600 mt-1">สอบที่โรงเรียน</p>
                                            </div>
                                        </label>
                                        <label class="exam-type-option flex items-center">
                                            <input type="radio" name="normalExamType" value="Online" class="mr-3">
                                            <div>
                                                <span class="font-medium">Online</span>
                                                <p class="text-sm text-gray-600 mt-1">สอบออนไลน์</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ส่วนกรอกคะแนน Pre-test -->
                    <div id="score-inputs-container">
                        <!-- คะแนนห้องเรียนพิเศษ -->
                        <div id="special-scores-section" class="score-input-section hidden">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">คะแนนห้องเรียนพิเศษ</h3>
                            
                            <!-- อันดับ -->
                            <div class="mb-6">
                                <label for="special_rank" class="block text-gray-700 font-semibold mb-2">อันดับที่ได้</label>
                                <input type="number" id="special_rank" class="input-field w-full md:w-48" placeholder="กรอกอันดับ" min="1" required>
                            </div>
                            
                            <!-- คะแนนแต่ละวิชา -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="score_special_math" class="block text-gray-700 font-semibold mb-2">คณิตศาสตร์</label>
                                    <div class="relative">
                                        <input type="number" id="score_special_math" class="input-field w-full pr-16" placeholder="0.00" min="0" max="50" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/50</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="score_special_science" class="block text-gray-700 font-semibold mb-2">วิทยาศาสตร์</label>
                                    <div class="relative">
                                        <input type="number" id="score_special_science" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="score_special_english" class="block text-gray-700 font-semibold mb-2">ภาษาอังกฤษ</label>
                                    <div class="relative">
                                        <input type="number" id="score_special_english" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- คะแนนรวม -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-700">คะแนนรวม:</span>
                                    <span id="special-total-score" class="text-2xl font-bold text-blue-600">0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- คะแนนห้องเรียนปกติ -->
                        <div id="normal-scores-section" class="score-input-section hidden">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">คะแนนห้องเรียนปกติ</h3>
                            
                            <!-- อันดับ -->
                            <div class="mb-6">
                                <label for="normal_rank" class="block text-gray-700 font-semibold mb-2">อันดับที่ได้</label>
                                <input type="number" id="normal_rank" class="input-field w-full md:w-48" placeholder="กรอกอันดับ" min="1" required>
                            </div>
                            
                            <!-- คะแนนแต่ละวิชา -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="score_normal_math" class="block text-gray-700 font-semibold mb-2">คณิตศาสตร์</label>
                                    <div class="relative">
                                        <input type="number" id="score_normal_math" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="score_normal_science" class="block text-gray-700 font-semibold mb-2">วิทยาศาสตร์</label>
                                    <div class="relative">
                                        <input type="number" id="score_normal_science" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="score_normal_english" class="block text-gray-700 font-semibold mb-2">ภาษาอังกฤษ</label>
                                    <div class="relative">
                                        <input type="number" id="score_normal_english" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="score_normal_thai" class="block text-gray-700 font-semibold mb-2">ภาษาไทย</label>
                                    <div class="relative">
                                        <input type="number" id="score_normal_thai" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="score_normal_social" class="block text-gray-700 font-semibold mb-2">สังคมศึกษา</label>
                                    <div class="relative">
                                        <input type="number" id="score_normal_social" class="input-field w-full pr-16" placeholder="0.00" min="0" max="30" step="0.01" required>
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/30</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- คะแนนรวม -->
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-700">คะแนนรวม:</span>
                                    <span id="normal-total-score" class="text-2xl font-bold text-green-600">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ส่วนที่ 2: เป้าหมายหลักสูตรในการสอบเข้า -->
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-800 mb-4">ส่วนที่ 2: เป้าหมายหลักสูตรในการสอบเข้า</h3>
                        
                        <!-- เป้าหมายห้องเรียนพิเศษ -->
                        <div id="target-special-section" class="mb-6 hidden">
                            <label class="block text-gray-700 font-semibold mb-3">หลักสูตรห้องเรียนพิเศษ</label>
                            <div class="space-y-3">
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="targetSpecial" value="EP" class="mr-3">
                                    <div>
                                        <span class="font-medium">EP (English Program)</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 4 วิชา: English 80, คณิต 50, วิทย์ 50, สัมภาษณ์ 20 คะแนน (เต็ม 200)</p>
                                    </div>
                                </label>
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="targetSpecial" value="SMTE" class="mr-3">
                                    <div>
                                        <span class="font-medium">SMTE (Science Math Technology and Environment)</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 2 วิชา: คณิต 50, วิทย์ 50 คะแนน (เต็ม 100)</p>
                                    </div>
                                </label>
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="targetSpecial" value="GM" class="mr-3">
                                    <div>
                                        <span class="font-medium">Gifted Math</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 3 วิชา: คณิต 50, วิทย์ 50, English 10 คะแนน (เต็ม 110)</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- เป้าหมายห้องเรียนปกติ -->
                        <div id="target-normal-section" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-3">หลักสูตรห้องเรียนปกติ</label>
                            <div class="space-y-3">
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="targetNormal" value="Normal_In" class="mr-3">
                                    <div>
                                        <span class="font-medium">ในเขตพื้นที่บริการ</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 5 วิชา: คณิต 20, วิทย์ 20, English 20, ไทย 20, สังคม 20 คะแนน (เต็ม 100)</p>
                                    </div>
                                </label>
                                <label class="curriculum-option flex items-center">
                                    <input type="radio" name="targetNormal" value="Normal_Out" class="mr-3">
                                    <div>
                                        <span class="font-medium">นอกเขตพื้นที่บริการ</span>
                                        <p class="text-sm text-gray-600 mt-1">สอบ 5 วิชา: คณิต 20, วิทย์ 20, English 20, ไทย 20, สังคม 20 คะแนน (เต็ม 100)</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center pt-6 flex justify-center space-x-4">
                        <button type="submit" class="btn btn-primary text-lg">
                            <i class="fas fa-paper-plane mr-2"></i> ส่งข้อมูลผลสำรวจ
                        </button>
                        <button type="button" id="reset-btn" class="btn btn-danger text-lg">
                            <i class="fas fa-undo mr-2"></i> รีเซ็ตข้อมูล
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>ข้อมูลในตารางจะอัปเดตอัตโนมัติเมื่อมีผู้ส่งข้อมูลใหม่เข้ามา
                </div>
                
                <div class="flex flex-wrap justify-center mb-6 space-x-2">
                    <button id="result-tab-special" class="result-tab active" onclick="switchResultTab('special')">ห้องเรียนพิเศษ</button>
                    <button id="result-tab-normal" class="result-tab" onclick="switchResultTab('normal')">ห้องเรียนปกติ</button>
                </div>
                
                <div class="flex flex-wrap justify-center mb-6 space-x-2">
                    <button id="exam-type-all" class="exam-type-tab active" onclick="switchExamTypeTab('all')">ทั้งหมด</button>
                    <button id="exam-type-onsite" class="exam-type-tab" onclick="switchExamTypeTab('On-site')">On-site</button>
                    <button id="exam-type-online" class="exam-type-tab" onclick="switchExamTypeTab('Online')">Online</button>
                </div>
                
                <div class="table-container border rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase">
                            <tr>
                                <th scope="col" class="py-3 px-4">อันดับ</th>
                                <th scope="col" class="py-3 px-4">ชื่อ</th>
                                <th scope="col" class="py-3 px-4">ประเภทสอบ</th>
                                <th scope="col" class="py-3 px-4 text-right">คะแนนรวม</th>
                                <th scope="col" class="py-3 px-4">คณิต</th>
                                <th scope="col" class="py-3 px-4">วิทย์</th>
                                <th scope="col" class="py-3 px-4">อังกฤษ</th>
                                <th scope="col" class="py-3 px-4">ไทย</th>
                                <th scope="col" class="py-3 px-4">สังคม</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <tr>
                                <td colspan="9" class="text-center py-6 text-gray-500">ยังไม่มีข้อมูล</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Analysis Section -->
            <div id="analysis-section" class="hidden">
                <div class="text-center max-w-4xl mx-auto">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-yellow-800 rounded-r-lg">
                        <h3 class="font-bold">วิเคราะห์คะแนนเปรียบเทียบคะแนนสอบ Pre-test กับคะแนนสอบเข้าจริง</h3>
                        <p>ระบบจะประมวลผลคะแนน Pre-test ของคุณเปรียบเทียบกับคะแนนสอบเข้าจริงปี 2568</p>
                    </div>
                    
                    <div id="analysis-results-container" class="text-left space-y-8">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-info-circle text-4xl mb-4 text-gray-400"></i>
                            <p class="text-lg">ยังไม่มีข้อมูลสำหรับการวิเคราะห์</p>
                            <p class="text-sm mt-2">กรุณากรอกข้อมูลในหน้า "กรอกข้อมูล" ก่อน</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Section -->
            <div id="admin-section" class="hidden">
                <div class="admin-panel">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Admin Panel</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md border">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">ดาวน์โหลดข้อมูล</h3>
                            <p class="text-gray-600 mb-4">ดาวน์โหลดข้อมูลทั้งหมดในรูปแบบ Excel</p>
                            <button id="download-excel" class="btn btn-success w-full">
                                <i class="fas fa-file-excel mr-2"></i> ดาวน์โหลด Excel
                            </button>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md border">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">สถิติข้อมูล</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">จำนวนผู้ตอบแบบสอบถาม:</span>
                                    <span id="total-submissions" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ห้องเรียนพิเศษ:</span>
                                    <span id="special-count" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ห้องเรียนปกติ:</span>
                                    <span id="normal-count" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">สอบทั้งสองหลักสูตร:</span>
                                    <span id="both-count" class="font-bold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md border">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">ข้อมูลทั้งหมด</h3>
                        <div class="table-container border rounded-lg">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4">ชื่อ</th>
                                        <th class="py-3 px-4">หลักสูตรที่สอบ</th>
                                        <th class="py-3 px-4">เป้าหมายพิเศษ</th>
                                        <th class="py-3 px-4">เป้าหมายปกติ</th>
                                        <th class="py-3 px-4">วันที่ส่ง</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-gray-500">ไม่มีข้อมูล</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Line OPC Section -->
        <div class="line-opc-section mx-6 mb-6">
            <div class="flex flex-col items-center">
                <div class="text-center mb-4">
                    <p class="text-lg font-semibold mb-2">🌟 รวบรวมข้อมูลและจัดทำโดย ... ลุ้นสอวอไปด้วยกันนะ 🌟</p>
                    <p class="text-xl font-bold">ครอบครัวยอดนารี❤️สตรีวิทยา</p>
                </div>
                <a href="https://line.me/ti/g2/ZRIN-ofnybH08hXhS6OYTfIMeKqvupT0Qzd44Q?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" 
                   target="_blank" class="line-opc-button">
                    <i class="fab fa-line mr-2 text-xl"></i>
                    Line OPC
                </a>
                <p class="text-sm mt-3 opacity-90">คลิกเพื่อเข้าร่วมกลุ่มไลน์ครอบครัวยอดนารี</p>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Developed for Satriwitthaya Pre-test Takers</p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAN3MBLEGtrXJfiD03EE9CtCNc3HSfJJk8",
            authDomain: "satriwit-pretest-2569-8f9c6.firebaseapp.com",
            databaseURL: "https://satriwit-pretest-2569-8f9c6-default-rtdb.firebaseio.com",
            projectId: "satriwit-pretest-2569-8f9c6",
            storageBucket: "satriwit-pretest-2569-8f9c6.firebasestorage.app",
            messagingSenderId: "609573903901",
            appId: "1:609573903901:web:b079287b90f5c449f9f0f4",
            measurementId: "G-SFZMJYBKJ0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // ข้อมูลสำหรับการคำนวณและวิเคราะห์
        const historicalData2568 = {
            EP: { 
                title: "EP ปี 2568", 
                max: 168.50, 
                avg: 139.89, 
                min: 119.17, 
                fullScore: 200 
            },
            SMTE: { 
                title: "SMTE ปี 2568", 
                max: 77.25, 
                avg: 58.58, 
                min: 47.75, 
                fullScore: 100 
            },
            GM: { 
                title: "GM ปี 2568", 
                max: 90.00, 
                avg: 73.30, 
                min: 66.00, 
                fullScore: 110 
            },
            Normal_In: { 
                title: "ห้องปกติ (ในเขต) ปี 2568", 
                max: 58.50, 
                avg: 50.33, 
                min: 41.00, 
                fullScore: 100 
            },
            Normal_Out: { 
                title: "ห้องปกติ (นอกเขต) ปี 2568", 
                max: 65.50, 
                avg: 51.41, 
                min: 44.00, 
                fullScore: 100 
            }
        };
        
        // ตัวแปรเก็บข้อมูล
        let allScores = [];
        let currentResultTab = 'special';
        let currentExamTypeTab = 'all';

        // ฟังก์ชันบันทึกข้อมูลไปยัง Firebase
        async function saveToFirebase(data) {
            try {
                const scoresRef = ref(database, 'scores');
                const newScoreRef = push(scoresRef);
                await set(newScoreRef, data);
                return true;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                return false;
            }
        }

        // ฟังก์ชันโหลดข้อมูลจาก Firebase
        function loadFromFirebase() {
            const scoresRef = ref(database, 'scores');
            onValue(scoresRef, (snapshot) => {
                const data = snapshot.val();
                allScores = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        allScores.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                
                updateAdminStats();
                applyFilters();
                updateAdminTable();
            });
        }

        // ฟังก์ชันสำหรับสลับแท็บหลัก
        window.switchView = (view) => {
            const sections = ['form-section', 'results-section', 'analysis-section', 'admin-section'];
            const tabs = ['tab-form', 'tab-results', 'tab-analysis', 'tab-admin'];
            
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));
            tabs.forEach(t => document.getElementById(t).classList.remove('active'));
            
            document.getElementById(`${view}-section`).classList.remove('hidden');
            document.getElementById(`tab-${view}`).classList.add('active');
            
            // แสดงปุ่มกลับไปหน้าแรกเฉพาะหน้า results และ analysis
            const backBtn = document.getElementById('back-to-form-btn');
            if (view === 'results' || view === 'analysis' || view === 'admin') {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }
            
            // โหลดข้อมูลเมื่อเปลี่ยนไปที่หน้า results หรือ analysis
            if (view === 'results') {
                applyFilters();
            } else if (view === 'analysis') {
                displayAnalysisResults();
            } else if (view === 'admin') {
                updateAdminStats();
                updateAdminTable();
            }
        };

        // ฟังก์ชันสำหรับสลับแท็บผลลัพธ์ (ห้องเรียนพิเศษ/ปกติ)
        window.switchResultTab = (tab) => {
            currentResultTab = tab;
            document.getElementById('result-tab-special').classList.toggle('active', tab === 'special');
            document.getElementById('result-tab-normal').classList.toggle('active', tab === 'normal');
            applyFilters();
        };

        // ฟังก์ชันสำหรับสลับแท็บประเภทการสอบ (ทั้งหมด/On-site/Online)
        window.switchExamTypeTab = (tab) => {
            currentExamTypeTab = tab;
            document.getElementById('exam-type-all').classList.toggle('active', tab === 'all');
            document.getElementById('exam-type-onsite').classList.toggle('active', tab === 'On-site');
            document.getElementById('exam-type-online').classList.toggle('active', tab === 'Online');
            applyFilters();
        };

        // ฟังก์ชันสำหรับแสดง/ซ่อนส่วนเลือกประเภทการสอบและส่วนกรอกคะแนน
        window.toggleExamTypeSelection = () => {
            const selectedCurriculum = document.querySelector('input[name="pretestCurriculum"]:checked').value;
            const specialExamType = document.getElementById('special-exam-type');
            const normalExamType = document.getElementById('normal-exam-type');
            const specialScoresSection = document.getElementById('special-scores-section');
            const normalScoresSection = document.getElementById('normal-scores-section');
            const targetSpecialSection = document.getElementById('target-special-section');
            const targetNormalSection = document.getElementById('target-normal-section');
            
            // รีเซ็ตค่าทั้งหมดก่อน
            specialExamType.classList.add('hidden');
            normalExamType.classList.add('hidden');
            specialScoresSection.classList.add('hidden');
            normalScoresSection.classList.add('hidden');
            targetSpecialSection.classList.add('hidden');
            targetNormalSection.classList.add('hidden');
            
            // ล้างค่าที่เลือก
            document.querySelectorAll('input[name="specialExamType"]').forEach(input => input.checked = false);
            document.querySelectorAll('input[name="normalExamType"]').forEach(input => input.checked = false);
            document.querySelectorAll('input[name="targetSpecial"]').forEach(input => input.checked = false);
            document.querySelectorAll('input[name="targetNormal"]').forEach(input => input.checked = false);
            
            if (selectedCurriculum === 'both') {
                specialExamType.classList.remove('hidden');
                normalExamType.classList.remove('hidden');
                specialScoresSection.classList.remove('hidden');
                normalScoresSection.classList.remove('hidden');
                targetSpecialSection.classList.remove('hidden');
                targetNormalSection.classList.remove('hidden');
            } else if (selectedCurriculum === 'special') {
                specialExamType.classList.remove('hidden');
                specialScoresSection.classList.remove('hidden');
                targetSpecialSection.classList.remove('hidden');
            } else if (selectedCurriculum === 'normal') {
                normalExamType.classList.remove('hidden');
                normalScoresSection.classList.remove('hidden');
                targetNormalSection.classList.remove('hidden');
            }
        };

        // ฟังก์ชันคำนวณคะแนนรวมอัตโนมัติ
        function setupAutoCalculate() {
            // คะแนนห้องเรียนพิเศษ
            const specialInputs = ['score_special_math', 'score_special_science', 'score_special_english'];
            specialInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateSpecialTotal);
            });

            // คะแนนห้องเรียนปกติ
            const normalInputs = ['score_normal_math', 'score_normal_science', 'score_normal_english', 'score_normal_thai', 'score_normal_social'];
            normalInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateNormalTotal);
            });
        }

        function calculateSpecialTotal() {
            const math = parseFloat(document.getElementById('score_special_math').value) || 0;
            const science = parseFloat(document.getElementById('score_special_science').value) || 0;
            const english = parseFloat(document.getElementById('score_special_english').value) || 0;
            const total = math + science + english;
            document.getElementById('special-total-score').textContent = total.toFixed(2);
        }

        function calculateNormalTotal() {
            const math = parseFloat(document.getElementById('score_normal_math').value) || 0;
            const science = parseFloat(document.getElementById('score_normal_science').value) || 0;
            const english = parseFloat(document.getElementById('score_normal_english').value) || 0;
            const thai = parseFloat(document.getElementById('score_normal_thai').value) || 0;
            const social = parseFloat(document.getElementById('score_normal_social').value) || 0;
            const total = math + science + english + thai + social;
            document.getElementById('normal-total-score').textContent = total.toFixed(2);
        }

        // ฟังก์ชันสำหรับรีเซ็ตฟอร์ม
        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('survey-form').reset();
            document.getElementById('special-scores-section').classList.add('hidden');
            document.getElementById('normal-scores-section').classList.add('hidden');
            document.getElementById('special-exam-type').classList.add('hidden');
            document.getElementById('normal-exam-type').classList.add('hidden');
            document.getElementById('target-special-section').classList.add('hidden');
            document.getElementById('target-normal-section').classList.add('hidden');
            document.getElementById('special-total-score').textContent = '0.00';
            document.getElementById('normal-total-score').textContent = '0.00';
        });

        // ฟังก์ชันจัดการการส่งฟอร์ม
        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // เก็บข้อมูลจากฟอร์ม
            const nickname = document.getElementById('nickname').value.trim() || 'ไม่ประสงค์ออกนาม';
            const pretestCurriculum = document.querySelector('input[name="pretestCurriculum"]:checked').value;
            const targetSpecial = document.querySelector('input[name="targetSpecial"]:checked')?.value;
            const targetNormal = document.querySelector('input[name="targetNormal"]:checked')?.value;
            
            // ตรวจสอบว่ากรอกข้อมูลครบถ้วน
            let isValid = true;
            let errorMessage = '';
            
            if (pretestCurriculum === 'special' || pretestCurriculum === 'both') {
                const specialExamType = document.querySelector('input[name="specialExamType"]:checked');
                const specialRank = document.getElementById('special_rank').value;
                const specialMath = document.getElementById('score_special_math').value;
                
                if (!specialExamType) {
                    isValid = false;
                    errorMessage = 'กรุณาเลือกประเภทการสอบสำหรับห้องเรียนพิเศษ';
                } else if (!specialRank || !specialMath) {
                    isValid = false;
                    errorMessage = 'กรุณากรอกข้อมูลคะแนนห้องเรียนพิเศษให้ครบถ้วน';
                } else if (!targetSpecial) {
                    isValid = false;
                    errorMessage = 'กรุณาเลือกเป้าหมายสำหรับห้องเรียนพิเศษ';
                }
            }
            
            if (pretestCurriculum === 'normal' || pretestCurriculum === 'both') {
                const normalExamType = document.querySelector('input[name="normalExamType"]:checked');
                const normalRank = document.getElementById('normal_rank').value;
                const normalMath = document.getElementById('score_normal_math').value;
                
                if (!normalExamType) {
                    isValid = false;
                    errorMessage = 'กรุณาเลือกประเภทการสอบสำหรับห้องเรียนปกติ';
                } else if (!normalRank || !normalMath) {
                    isValid = false;
                    errorMessage = 'กรุณากรอกข้อมูลคะแนนห้องเรียนปกติให้ครบถ้วน';
                } else if (!targetNormal) {
                    isValid = false;
                    errorMessage = 'กรุณาเลือกเป้าหมายสำหรับห้องเรียนปกติ';
                }
            }
            
            if (!isValid) {
                showMessage(errorMessage, 'error');
                return;
            }
            
            // เก็บข้อมูลคะแนน
            let submissionData = {
                nickname: nickname,
                pretestCurriculum: pretestCurriculum,
                targetSpecial: targetSpecial,
                targetNormal: targetNormal,
                createdAt: new Date().toISOString()
            };
            
            // เก็บข้อมูลคะแนนตามหลักสูตรที่เลือก
            if (pretestCurriculum === 'special' || pretestCurriculum === 'both') {
                const specialExamType = document.querySelector('input[name="specialExamType"]:checked').value;
                
                submissionData.special = {
                    examType: specialExamType,
                    rank: parseInt(document.getElementById('special_rank').value) || 0,
                    scores: {
                        math: parseFloat(document.getElementById('score_special_math').value) || 0,
                        science: parseFloat(document.getElementById('score_special_science').value) || 0,
                        english: parseFloat(document.getElementById('score_special_english').value) || 0
                    },
                    totalScore: (parseFloat(document.getElementById('score_special_math').value) || 0) +
                               (parseFloat(document.getElementById('score_special_science').value) || 0) +
                               (parseFloat(document.getElementById('score_special_english').value) || 0)
                };
            }
            
            if (pretestCurriculum === 'normal' || pretestCurriculum === 'both') {
                const normalExamType = document.querySelector('input[name="normalExamType"]:checked').value;
                
                submissionData.normal = {
                    examType: normalExamType,
                    rank: parseInt(document.getElementById('normal_rank').value) || 0,
                    scores: {
                        math: parseFloat(document.getElementById('score_normal_math').value) || 0,
                        science: parseFloat(document.getElementById('score_normal_science').value) || 0,
                        english: parseFloat(document.getElementById('score_normal_english').value) || 0,
                        thai: parseFloat(document.getElementById('score_normal_thai').value) || 0,
                        social: parseFloat(document.getElementById('score_normal_social').value) || 0
                    },
                    totalScore: (parseFloat(document.getElementById('score_normal_math').value) || 0) +
                               (parseFloat(document.getElementById('score_normal_science').value) || 0) +
                               (parseFloat(document.getElementById('score_normal_english').value) || 0) +
                               (parseFloat(document.getElementById('score_normal_thai').value) || 0) +
                               (parseFloat(document.getElementById('score_normal_social').value) || 0)
                };
            }
            
            // บันทึกข้อมูลไปยัง Firebase
            toggleLoading(true);
            const success = await saveToFirebase(submissionData);
            toggleLoading(false);
            
            if (success) {
                showMessage("ส่งข้อมูลสำเร็จ! ขอบคุณที่ร่วมแบ่งปันข้อมูล 🙏", "success");
                
                // รีเซ็ตฟอร์ม
                document.getElementById('survey-form').reset();
                document.getElementById('special-scores-section').classList.add('hidden');
                document.getElementById('normal-scores-section').classList.add('hidden');
                document.getElementById('special-exam-type').classList.add('hidden');
                document.getElementById('normal-exam-type').classList.add('hidden');
                document.getElementById('target-special-section').classList.add('hidden');
                document.getElementById('target-normal-section').classList.add('hidden');
                document.getElementById('special-total-score').textContent = '0.00';
                document.getElementById('normal-total-score').textContent = '0.00';
            } else {
                showMessage("เกิดข้อผิดพลาดในการส่งข้อมูล กรุณาลองใหม่", "error");
            }
        });

        // ฟังก์ชันแสดงข้อความแจ้งเตือน
        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            const colors = { success: 'green', error: 'red', warning: 'yellow' };
            const icons = { 
                success: 'fa-check-circle', 
                error: 'fa-times-circle', 
                warning: 'fa-exclamation-triangle' 
            };
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 rounded-lg shadow-lg mb-2 bg-${colors[type]}-100 border-l-4 border-${colors[type]}-500 text-${colors[type]}-800 transition-all duration-300 transform translate-x-full opacity-0`;
            alertDiv.innerHTML = `<i class="fas ${icons[type]} mr-2"></i> <span class="font-semibold">${message}</span>`;
            
            box.prepend(alertDiv);
            
            setTimeout(() => alertDiv.classList.remove('translate-x-full', 'opacity-0'), 10);
            
            setTimeout(() => {
                alertDiv.classList.add('opacity-0');
                setTimeout(() => alertDiv.remove(), 400);
            }, 5000);
        }

        // ฟังก์ชันโหลดข้อมูลเมื่อเริ่มต้น
        document.addEventListener('DOMContentLoaded', function() {
            // โหลดข้อมูลจาก Firebase
            loadFromFirebase();
            
            // ตั้งค่าการคำนวณคะแนนรวมอัตโนมัติ
            setupAutoCalculate();
            
            // เพิ่ม Event Listener สำหรับการเลือกตัวเลือก
            document.querySelectorAll('.curriculum-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // อัพเดตสถานะ selected
                    document.querySelectorAll('.curriculum-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // ถ้าเป็นตัวเลือกหลักสูตร Pre-test ให้อัพเดตฟอร์ม
                    if (radio.name === 'pretestCurriculum') {
                        toggleExamTypeSelection();
                    }
                });
            });

            // เพิ่ม Event Listener สำหรับการเลือกประเภทการสอบ
            document.querySelectorAll('.exam-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // อัพเดตสถานะ selected
                    document.querySelectorAll('.exam-type-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });

            // ตั้งค่าปุ่มดาวน์โหลด Excel
            document.getElementById('download-excel').addEventListener('click', function() {
                if (allScores.length === 0) {
                    showMessage('ไม่มีข้อมูลให้ดาวน์โหลด', 'warning');
                    return;
                }

                try {
                    // สร้างข้อมูลสำหรับ Excel
                    const excelData = allScores.map(score => {
                        const row = {
                            'ชื่อ': score.nickname,
                            'หลักสูตรที่สอบ': score.pretestCurriculum === 'special' ? 'ห้องเรียนพิเศษ' : 
                                            score.pretestCurriculum === 'normal' ? 'ห้องเรียนปกติ' : 'ทั้งสองหลักสูตร',
                            'เป้าหมายพิเศษ': score.targetSpecial || '-',
                            'เป้าหมายปกติ': score.targetNormal || '-',
                            'วันที่ส่ง': new Date(score.createdAt).toLocaleDateString('th-TH')
                        };

                        // เพิ่มข้อมูลคะแนนห้องเรียนพิเศษ
                        if (score.special) {
                            row['อันดับพิเศษ'] = score.special.rank;
                            row['ประเภทสอบพิเศษ'] = score.special.examType;
                            row['คณิตพิเศษ'] = score.special.scores.math;
                            row['วิทย์พิเศษ'] = score.special.scores.science;
                            row['อังกฤษพิเศษ'] = score.special.scores.english;
                            row['รวมพิเศษ'] = score.special.totalScore;
                        }

                        // เพิ่มข้อมูลคะแนนห้องเรียนปกติ
                        if (score.normal) {
                            row['อันดับปกติ'] = score.normal.rank;
                            row['ประเภทสอบปกติ'] = score.normal.examType;
                            row['คณิตปกติ'] = score.normal.scores.math;
                            row['วิทย์ปกติ'] = score.normal.scores.science;
                            row['อังกฤษปกติ'] = score.normal.scores.english;
                            row['ไทยปกติ'] = score.normal.scores.thai;
                            row['สังคมปกติ'] = score.normal.scores.social;
                            row['รวมปกติ'] = score.normal.totalScore;
                        }

                        return row;
                    });

                    // สร้าง worksheet
                    const worksheet = XLSX.utils.json_to_sheet(excelData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'คะแนน Pre-test');

                    // สร้างไฟล์และดาวน์โหลด
                    XLSX.writeFile(workbook, `คะแนน_Pre-test_สตรีวิทยา_2569_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    showMessage('ดาวน์โหลดไฟล์ Excel สำเร็จ', 'success');
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    showMessage('เกิดข้อผิดพลาดในการดาวน์โหลด', 'error');
                }
            });
        });

        // ฟังก์ชันอัพเดตสถิติสำหรับ Admin
        function updateAdminStats() {
            const total = allScores.length;
            const specialCount = allScores.filter(score => 
                score.pretestCurriculum === 'special').length;
            const normalCount = allScores.filter(score => 
                score.pretestCurriculum === 'normal').length;
            const bothCount = allScores.filter(score => 
                score.pretestCurriculum === 'both').length;

            document.getElementById('total-submissions').textContent = total;
            document.getElementById('special-count').textContent = specialCount;
            document.getElementById('normal-count').textContent = normalCount;
            document.getElementById('both-count').textContent = bothCount;
        }

        // ฟังก์ชันอัพเดตตาราง Admin
        function updateAdminTable() {
            const tbody = document.getElementById('admin-table-body');
            
            if (allScores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">ไม่มีข้อมูล</td></tr>';
                return;
            }

            tbody.innerHTML = allScores.map(score => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">${score.nickname}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            score.pretestCurriculum === 'special' ? 'bg-blue-100 text-blue-800' :
                            score.pretestCurriculum === 'normal' ? 'bg-green-100 text-green-800' :
                            'bg-purple-100 text-purple-800'
                        }">
                            ${score.pretestCurriculum === 'special' ? 'ห้องเรียนพิเศษ' :
                            score.pretestCurriculum === 'normal' ? 'ห้องเรียนปกติ' : 'ทั้งสองหลักสูตร'}
                        </span>
                    </td>
                    <td class="py-3 px-4">${score.targetSpecial || '-'}</td>
                    <td class="py-3 px-4">${score.targetNormal || '-'}</td>
                    <td class="py-3 px-4 text-sm">${new Date(score.createdAt).toLocaleDateString('th-TH')}</td>
                </tr>
            `).join('');
        }

        // ฟังก์ชันกรองและแสดงผลข้อมูล
        function applyFilters() {
            let filtered = [...allScores];
            
            // กรองตามประเภทห้องเรียน
            if (currentResultTab === 'special') {
                filtered = filtered.filter(score => 
                    score.pretestCurriculum === 'special' || score.pretestCurriculum === 'both'
                );
            } else {
                filtered = filtered.filter(score => 
                    score.pretestCurriculum === 'normal' || score.pretestCurriculum === 'both'
                );
            }
            
            // กรองตามประเภทการสอบ
            if (currentExamTypeTab !== 'all') {
                if (currentResultTab === 'special') {
                    filtered = filtered.filter(score => 
                        score.special && score.special.examType === currentExamTypeTab
                    );
                } else {
                    filtered = filtered.filter(score => 
                        score.normal && score.normal.examType === currentExamTypeTab
                    );
                }
            }
            
            // เรียงลำดับตามอันดับ
            if (currentResultTab === 'special') {
                filtered.sort((a, b) => (a.special?.rank || Infinity) - (b.special?.rank || Infinity));
            } else {
                filtered.sort((a, b) => (a.normal?.rank || Infinity) - (b.normal?.rank || Infinity));
            }
            
            renderScoresTable(filtered);
        }

        // ฟังก์ชันแสดงตารางผลลัพธ์
        function renderScoresTable(scores) {
            const tableBody = document.getElementById('results-table-body');
            
            if (scores.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-6 text-gray-500">ยังไม่มีข้อมูล</td></tr>`;
                return;
            }
            
            let rows = '';
            
            scores.forEach(score => {
                if (currentResultTab === 'special' && score.special) {
                    rows += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-bold text-gray-900">${score.special.rank}</td>
                            <td class="py-3 px-4">${score.nickname}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${score.special.examType === 'On-site' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${score.special.examType}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-right font-bold text-blue-600">${score.special.totalScore.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.special.scores.math.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.special.scores.science.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.special.scores.english.toFixed(2)}</td>
                            <td class="py-3 px-4">-</td>
                            <td class="py-3 px-4">-</td>
                        </tr>
                    `;
                } else if (currentResultTab === 'normal' && score.normal) {
                    rows += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-bold text-gray-900">${score.normal.rank}</td>
                            <td class="py-3 px-4">${score.nickname}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${score.normal.examType === 'On-site' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${score.normal.examType}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-right font-bold text-blue-600">${score.normal.totalScore.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.normal.scores.math.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.normal.scores.science.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.normal.scores.english.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.normal.scores.thai.toFixed(2)}</td>
                            <td class="py-3 px-4">${score.normal.scores.social.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });
            
            tableBody.innerHTML = rows;
        }

        // ฟังก์ชันแสดงผลการวิเคราะห์คะแนน
        function displayAnalysisResults() {
            const container = document.getElementById('analysis-results-container');
            
            if (allScores.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-info-circle text-4xl mb-4 text-gray-400"></i>
                        <p class="text-lg">ยังไม่มีข้อมูลสำหรับการวิเคราะห์</p>
                        <p class="text-sm mt-2">กรุณากรอกข้อมูลในหน้า "กรอกข้อมูล" ก่อน</p>
                    </div>
                `;
                return;
            }
            
            // ใช้ข้อมูลล่าสุดสำหรับการวิเคราะห์
            const latestScore = allScores[allScores.length - 1];
            let html = '';
            
            // วิเคราะห์สำหรับเป้าหมายห้องเรียนพิเศษ
            if (latestScore.targetSpecial && (latestScore.pretestCurriculum === 'special' || latestScore.pretestCurriculum === 'both')) {
                const target = latestScore.targetSpecial;
                const preTestScores = latestScore.special.scores;
                const projectedScore = calculateRealExamScore(preTestScores, target);
                const stats = historicalData2568[target];
                
                html += createAnalysisCard(stats, projectedScore, target, latestScore.special.totalScore);
            }
            
            // วิเคราะห์สำหรับเป้าหมายห้องเรียนปกติ
            if (latestScore.targetNormal && (latestScore.pretestCurriculum === 'normal' || latestScore.pretestCurriculum === 'both')) {
                const target = latestScore.targetNormal;
                const preTestScores = latestScore.normal.scores;
                const projectedScore = calculateRealExamScore(preTestScores, target);
                const stats = historicalData2568[target];
                
                html += createAnalysisCard(stats, projectedScore, target, latestScore.normal.totalScore);
            }
            
            container.innerHTML = html || `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-info-circle text-4xl mb-4 text-gray-400"></i>
                    <p class="text-lg">ไม่พบข้อมูลเป้าหมายสำหรับการวิเคราะห์</p>
                    <p class="text-sm mt-2">กรุณาเลือกเป้าหมายในการสอบเข้าในหน้า "กรอกข้อมูล"</p>
                </div>
            `;
        }

        // ฟังก์ชันคำนวณคะแนนสอบจริงจากคะแนน Pre-test
        function calculateRealExamScore(preTestScores, targetCurriculum) {
            let projectedScore = 0;
            
            switch (targetCurriculum) {
                case 'EP':
                    // Math: 50, Science: 50 (30->50), English: 80 (30->80), Interview: 20
                    projectedScore = (preTestScores.math || 0) + 
                                    (preTestScores.science / 30 * 50) + 
                                    (preTestScores.english / 30 * 80) + 20;
                    break;
                case 'GM':
                    // Math: 50, Science: 50 (30->50), English: 10 (30->10)
                    projectedScore = (preTestScores.math || 0) + 
                                    (preTestScores.science / 30 * 50) + 
                                    (preTestScores.english / 30 * 10);
                    break;
                case 'SMTE':
                    // Math: 50, Science: 50 (30->50)
                    projectedScore = (preTestScores.math || 0) + 
                                    (preTestScores.science / 30 * 50);
                    break;
                case 'Normal_In':
                case 'Normal_Out':
                    // All subjects scaled to 100 total
                    projectedScore = ((preTestScores.math || 0) + 
                                     (preTestScores.science || 0) + 
                                     (preTestScores.english || 0) + 
                                     (preTestScores.thai || 0) + 
                                     (preTestScores.social || 0)) / 150 * 100;
                    break;
            }
            
            return projectedScore;
        }

        // ฟังก์ชันสร้างการ์ดแสดงผลการวิเคราะห์
        function createAnalysisCard(stats, projectedScore, target, preTestTotal) {
            const { title, min, avg, max, fullScore } = stats;
            const scorePercent = Math.min(100, (projectedScore / fullScore * 100)).toFixed(2);
            const minPercent = (min / fullScore * 100);
            const avgPercent = (avg / fullScore * 100);
            const maxPercent = (max / fullScore * 100);
            
            return `
                <div class="border rounded-lg p-6 shadow-md bg-white">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-600">คะแนน Pre-test ของคุณ</p>
                            <p class="text-3xl font-extrabold text-blue-600">${preTestTotal.toFixed(2)}</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <p class="text-gray-600">คะแนนสอบจริงที่คาดการณ์</p>
                            <p class="text-3xl font-extrabold text-green-600">${projectedScore.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">จากเต็ม ${fullScore} คะแนน</p>
                        </div>
                    </div>
                    
                    ${target === 'EP' ? 
                        `<div class="text-sm text-center bg-orange-100 text-orange-700 p-2 rounded-md mb-6">
                            <b>*หมายเหตุ:</b> คะแนนนี้คำนวณโดยสมมติว่าคุณได้คะแนนส่วนสัมภาษณ์เต็ม 20 คะแนน
                        </div>` : ''
                    }
                    
                    <div class="relative h-8 bg-gray-200 rounded-full mb-4 w-full">
                        <div class="absolute h-full bg-gradient-to-r from-red-400 via-yellow-400 to-green-400 rounded-full" style="width:100%;"></div>
                        
                        <!-- Min marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${minPercent}%;">
                            <div class="w-1 h-10 bg-red-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">ต่ำสุด</span>
                        </div>
                        
                        <!-- Avg marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${avgPercent}%;">
                            <div class="w-1 h-10 bg-yellow-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded">เฉลี่ย</span>
                        </div>
                        
                        <!-- Max marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${maxPercent}%;">
                            <div class="w-1 h-10 bg-green-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded">สูงสุด</span>
                        </div>
                        
                        <!-- User score marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${scorePercent}%;">
                            <div class="w-1 h-10 bg-indigo-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded">คุณ</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-600 px-1">
                        <span>0</span>
                        <span>${fullScore}</span>
                    </div>
                    
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-red-50 p-3 rounded-lg">
                            <p class="font-semibold text-red-600">ต่ำสุดปี 68</p>
                            <p class="text-2xl font-bold">${min.toFixed(2)}</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="font-semibold text-yellow-600">เฉลี่ยปี 68</p>
                            <p class="text-2xl font-bold">${avg.toFixed(2)}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="font-semibold text-green-600">สูงสุดปี 68</p>
                            <p class="text-2xl font-bold">${max.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ฟังก์ชัน toggle loading
        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
