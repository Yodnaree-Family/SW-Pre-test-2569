<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสำรวจคะแนน Pre-test สตรีวิทยา 2569</title>
    <!-- ใช้ Tailwind CSS ผ่าน CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- เพิ่ม Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- เพิ่ม Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- เพิ่ม SheetJS สำหรับ Export Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- เพิ่มไลบรารีสำหรับบันทึกเป็น PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Reset และ Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #f7f8fc;
            line-height: 1.6;
            font-size: 16px;
            position: relative;
        }
        
        /* Watermark Styles */
        .watermark {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.1;
            background: transparent;
        }
        
        .watermark-text {
            position: absolute;
            color: #6b7280;
            font-size: 20px;
            font-weight: 500;
            transform: rotate(-45deg);
            white-space: nowrap;
        }
        
        /* Custom Styles */
        .header-gradient {
            background: linear-gradient(135deg, #2a2a72 0%, #009ffd 100%);
        }
        
        .input-field {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb;
            width: 100%;
            font-size: 16px;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        
        .input-field.error {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }
        
        .btn {
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #60a5fa);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(59, 130, 246, 0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #6b7280, #9ca3af);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(107, 114, 128, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(to right, #16a34a, #22c55e);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(22, 163, 74, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #dc2626, #ef4444);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(220, 38, 38, 0.2);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #d97706, #f59e0b);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(217, 119, 6, 0.2);
        }
        
        .exam-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            margin-bottom: 1rem;
        }
        
        .exam-type-card:hover {
            border-color: #9ca3af;
        }
        
        .exam-type-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .exam-type-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .exam-date {
            color: #dc2626;
            font-weight: 600;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .score-input-section {
            background: #f8f9fa;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        .success-message {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .tab-button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #f9fafb;
            color: #4b5563;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .tab-button.active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #a5b4fc;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard Styles */
        .dashboard-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
        }
        
        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1f2937;
            text-align: center;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #f9fafb;
            color: #4b5563;
        }
        
        .dashboard-tab.active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #a5b4fc;
        }
        
        .chart-container-improved {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .comparison-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border-left: 4px solid #3b82f6;
        }
        
        .comparison-header {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .comparison-score {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .score-good {
            color: #16a34a;
        }
        
        .score-average {
            color: #d97706;
        }
        
        .score-low {
            color: #dc2626;
        }
        
        .note-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        .admin-login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .admin-table th {
            background-color: #4f46e5;
            color: white;
        }
        
        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .delete-btn:hover {
            background: #b91c1c;
        }

        /* CSS สำหรับการวิเคราะห์ */
        .chance-high { background: linear-gradient(to right, #16a34a, #22c55e); }
        .chance-medium { background: linear-gradient(to right, #d97706, #f59e0b); }
        .chance-low { background: linear-gradient(to right, #f97316, #fb923c); }

        .strength-item { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .weakness-item { background: #fffbeb; border: 1px solid #fde68a; }
        .improvement-item { background: #f0f9ff; border: 1px solid #bae6fd; }
        
        .subject-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        .subject-table th, .subject-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            text-align: center;
        }
        .subject-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        .subject-table td {
            color: #4b5563;
        }
        .subject-table .score-pretest {
            font-weight: 600;
            color: #3b82f6;
        }
        .subject-table .score-projected {
            font-weight: 600;
            color: #16a34a;
        }

        /* CSS สำหรับแท็บวิเคราะห์ */
        .analysis-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #f9fafb;
            color: #4b5563;
            margin: 0 0.25rem;
        }
        
        .analysis-tab.active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #a5b4fc;
        }
        
        .analysis-tab-content {
            display: none;
        }
        
        .analysis-tab-content.active {
            display: block;
        }
        
        /* CSS สำหรับปุ่มลบทั้งหมด */
        .btn-delete-all {
            background: linear-gradient(to right, #dc2626, #ef4444);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-delete-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(220, 38, 38, 0.2);
        }
        
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* CSS สำหรับการพิมพ์ - ปรับปรุงใหม่ */
        @media print {
            .no-print, 
            .tab-button, 
            #back-to-form-btn, 
            #admin-logout-btn,
            #save-analysis-btn,
            #print-analysis-btn,
            .line-opc-section,
            footer,
            .analysis-tab,
            .btn,
            .watermark {
                display: none !important;
            }
            
            body {
                background: white !important;
                font-size: 12pt;
                line-height: 1.4;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .header-gradient {
                background: #3b82f6 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
            }
            
            .dashboard-card, .chart-card, .comparison-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                break-inside: avoid;
            }
            
            .analysis-tab-content.active {
                display: block !important;
                page-break-inside: avoid;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            /* ปรับปรุงตารางสำหรับการพิมพ์ */
            .subject-table {
                width: 100%;
                font-size: 10pt;
                border: 1px solid #000;
            }
            
            .subject-table th, .subject-table td {
                border: 1px solid #000;
                padding: 4px 6px;
            }
            
            /* ปรับปรุงกราฟแท่งสำหรับการพิมพ์ */
            .chance-high, .chance-medium, .chance-low {
                -webkit-print-color-adjust: exact;
            }
            
            /* ปรับปรุงสีสำหรับการพิมพ์ */
            .score-good {
                color: #16a34a !important;
                -webkit-print-color-adjust: exact;
            }
            
            .score-average {
                color: #d97706 !important;
                -webkit-print-color-adjust: exact;
            }
            
            .score-low {
                color: #dc2626 !important;
                -webkit-print-color-adjust: exact;
            }
            
            .strength-item, .weakness-item, .improvement-item {
                border: 1px solid #000 !important;
            }
            
            /* แสดงลายน้ำในการพิมพ์ */
            .print-watermark {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 9999;
                opacity: 0.1;
                background: transparent;
            }
            
            .print-watermark-text {
                position: absolute;
                color: #6b7280;
                font-size: 20px;
                font-weight: 500;
                transform: rotate(-45deg);
                white-space: nowrap;
            }
        }
        
        @media (min-width: 640px) {
            body {
                font-size: 16px;
            }
            
            .tab-button {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                margin-bottom: 0;
            }
            
            .btn {
                font-size: 1rem;
            }
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:w-48 { width: 12rem; }
        }
        
        @media (max-width: 640px) {
            .stat-number {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <!-- Watermark -->
    <div class="watermark" id="watermark">
        <!-- Watermark text will be added by JavaScript -->
    </div>
    
    <!-- Message Box -->
    <div id="message-box" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
    
    <!-- Confirmation Modal สำหรับลบข้อมูลทั้งหมด -->
    <div id="delete-all-modal" class="confirmation-modal hidden">
        <div class="confirmation-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ยืนยันการลบข้อมูลทั้งหมด</h3>
            <p class="text-gray-600 mb-6">คุณกำลังจะลบข้อมูลทั้งหมดในระบบ การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <p class="text-red-600 font-semibold mb-4">พิมพ์ "DELETE ALL" เพื่อยืนยันการลบ</p>
            <input type="text" id="delete-all-confirmation" class="input-field mb-4" placeholder="พิมพ์ DELETE ALL">
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-all" class="btn btn-danger">ลบทั้งหมด</button>
                <button id="cancel-delete-all" class="btn btn-secondary">ยกเลิก</button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <div class="max-w-7xl mx-auto text-center py-3 mb-4 bg-pink-100 rounded-xl shadow-md border-2 border-pink-300">
        <h2 class="text-lg sm:text-2xl font-extrabold text-pink-700 tracking-wider">
            ครอบครัวยอดนารี ❤️ สตรีวิทยา
        </h2>
    </div>
    
     <!-- Main Content -->
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <header class="text-center p-6 sm:p-10 header-gradient relative">
            <button id="back-to-form-btn" class="absolute top-4 left-4 btn btn-secondary text-sm hidden" onclick="switchView('form')">
                <i class="fas fa-arrow-left mr-1"></i> กลับหน้ากรอกข้อมูล
            </button>
            <button id="admin-logout-btn" class="absolute top-4 right-4 btn btn-warning text-sm hidden" onclick="adminLogout()">
                <i class="fas fa-sign-out-alt mr-1"></i> ออกจากระบบ Admin
            </button>
            <h1 class="text-xl sm:text-3xl md:text-4xl font-extrabold text-white leading-tight">
                ระบบสำรวจและวิเคราะห์คะแนน Pre-test สตรีวิทยา
            </h1>
            <p class="text-base sm:text-lg text-blue-200 mt-2">ปีการศึกษา 2569</p>
        </header>
        
        <main class="p-4 sm:p-6 md:p-8">
            <!-- Connection Status -->
            <div id="connection-status" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-yellow-800 rounded-r-lg hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="connection-status-text">กำลังตรวจสอบการเชื่อมต่อกับ Firebase...</span>
                    </div>
                    <button onclick="testConnection()" class="btn btn-secondary text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> ทดสอบการเชื่อมต่อ
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex flex-wrap justify-center border-b mb-6 space-x-2 sm:space-x-4">
                <button id="tab-dashboard" class="tab-button active" onclick="switchView('dashboard')"><i class="fas fa-chart-pie mr-2"></i>แดชบอร์ดและสรุปผล</button>
                <button id="tab-form" class="tab-button" onclick="switchView('form')"><i class="fas fa-edit mr-2"></i>กรอกข้อมูล</button>
                <button id="tab-results" class="tab-button" onclick="switchView('results')"><i class="fas fa-chart-bar mr-2"></i>ดูผลสำรวจรวม</button>
                <button id="tab-analysis" class="tab-button" onclick="switchView('analysis')"><i class="fas fa-calculator mr-2"></i>วิเคราะห์คะแนน</button>
                <button id="tab-admin" class="tab-button" onclick="switchView('admin-login')"><i class="fas fa-cog mr-2"></i>Admin</button>
            </div>

            <!-- Success Message -->
            <div id="success-message" class="success-message hidden">
                <!-- เนื้อหาจะถูกแทนที่ด้วย JavaScript -->
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <div class="text-center max-w-6xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">ภาพรวมผลสำรวจคะแนน Pre-test</h2>
                    
                    <!-- Dashboard Filters -->
                    <div id="dashboard-filters" class="flex flex-wrap justify-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                        <div>
                            <label for="dashboard-filter-curriculum" class="block text-sm font-medium text-gray-700 mb-1">ประเภทหลักสูตร</label>
                            <select id="dashboard-filter-curriculum" class="input-field text-sm" onchange="renderFullDashboard()">
                                <option value="all">ทั้งหมด</option>
                                <option value="Special">ห้องเรียนพิเศษ</option>
                                <option value="Normal">ห้องเรียนปกติ</option>
                            </select>
                        </div>
                        <div>
                            <label for="dashboard-filter-grade" class="block text-sm font-medium text-gray-700 mb-1">ระดับชั้น</label>
                            <select id="dashboard-filter-grade" class="input-field text-sm" onchange="renderFullDashboard()">
                                <option value="all">ทั้งหมด</option>
                                <option value="grade4">ประถมศึกษาปีที่ 4</option>
                                <option value="grade5">ประถมศึกษาปีที่ 5</option>
                                <option value="grade6">ประถมศึกษาปีที่ 6</option>
                            </select>
                        </div>
                    </div>

                    <!-- สถิติสำคัญ -->
                    <div class="dashboard-grid">
                        <div class="dashboard-card text-center">
                            <div class="text-gray-500 text-sm font-semibold mb-2">ผู้ตอบแบบสำรวจ (ที่กรองแล้ว)</div>
                            <div class="stat-number text-blue-600" id="total-respondents">0</div>
                            <div class="text-xs text-gray-500 mt-2">คน</div>
                        </div>
                        
                        <div class="dashboard-card text-center">
                            <div class="text-gray-500 text-sm font-semibold mb-2">คะแนนเฉลี่ย (ที่กรองแล้ว)</div>
                            <div class="stat-number text-green-600" id="average-score">0.00</div>
                            <div class="text-xs text-gray-500 mt-2">คะแนน</div>
                        </div>
                        
                        <div class="dashboard-card text-center">
                            <div class="text-gray-500 text-sm font-semibold mb-2">คะแนนสูงสุด (ที่กรองแล้ว)</div>
                            <div class="stat-number text-purple-600" id="max-score">0.00</div>
                            <div class="text-xs text-gray-500 mt-2">คะแนน</div>
                        </div>
                        
                        <div class="dashboard-card text-center">
                            <div class="text-gray-500 text-sm font-semibold mb-2">คะแนนต่ำสุด (ที่กรองแล้ว)</div>
                            <div class="stat-number text-red-600" id="min-score">0.00</div>
                            <div class="text-xs text-gray-500 mt-2">คะแนน</div>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator for Dashboard -->
                    <div id="dashboard-loading-indicator" class="text-center py-6 sm:py-8 hidden">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-gray-600">กำลังโหลดข้อมูลแดชบอร์ด...</p>
                    </div>

                    <!-- Dashboard Charts Container -->
                    <div id="dashboard-charts-container" class="mt-6">
                        <!-- กราฟจะถูกโหลดที่นี่โดย JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Form Section -->
            <div id="form-section" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800 text-sm sm:text-base">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>กรุณากรอกข้อมูลตามความเป็นจริงเพื่อประโยชน์ในการวิเคราะห์คะแนน</span>
                </div>
                
                <!-- ข้อมูลพื้นฐาน -->
                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">ข้อมูลพื้นฐาน</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ชื่อเล่น (ไม่บังคับ)</label>
                            <input type="text" id="nickname" class="input-field" placeholder="กรอกชื่อเล่น (ไม่บังคับ)" maxlength="20">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ระดับชั้นปัจจุบัน <span class="text-red-600">*</span></label>
                            <select id="current-grade" class="input-field" required>
                                <option value="">เลือกระดับชั้น</option>
                                <option value="grade4">ประถมศึกษาปีที่ 4</option>
                                <option value="grade5">ประถมศึกษาปีที่ 5</option>
                                <option value="grade6">ประถมศึกษาปีที่ 6</option>
                            </select>
                            <div id="current-grade-error" class="text-red-600 text-sm mt-1 hidden">
                                <i class="fas fa-exclamation-circle mr-1"></i>กรุณาเลือกระดับชั้น
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- เลือกประเภทการสอบ -->
                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">เลือกประเภทการสอบที่ต้องการบันทึกคะแนน</h2>
                    <p class="text-gray-600 mb-4 text-sm sm:text-base">สามารถเลือกได้มากกว่า 1 ประเภท (เลือกประเภทที่คุณได้สอบจริง)</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ห้องเรียนพิเศษ (On-site) -->
                        <div class="exam-type-card" onclick="toggleExamType('specialOnsite')">
                            <div class="exam-type-icon text-blue-600">
                                <i class="fas fa-school"></i>
                            </div>
                            <h3 class="font-bold text-base sm:text-lg">ห้องเรียนพิเศษ (On-site)</h3>
                            <p class="exam-date">สอบวันเสาร์ที่ 20 ธันวาคม 2568</p>
                            <div class="mt-2 flex items-center">
                                <input type="checkbox" id="specialOnsite-checkbox" class="mr-2" onchange="toggleExamType('specialOnsite')">
                                <span class="text-sm sm:text-base">เลือกประเภทนี้</span>
                            </div>
                        </div>
                        
                        <!-- ห้องเรียนปกติ (On-site) -->
                        <div class="exam-type-card" onclick="toggleExamType('normalOnsite')">
                            <div class="exam-type-icon text-green-600">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3 class="font-bold text-base sm:text-lg">ห้องเรียนปกติ (On-site)</h3>
                            <p class="exam-date">สอบวันเสาร์ที่ 20 ธันวาคม 2568</p>
                            <div class="mt-2 flex items-center">
                                <input type="checkbox" id="normalOnsite-checkbox" class="mr-2" onchange="toggleExamType('normalOnsite')">
                                <span class="text-sm sm:text-base">เลือกประเภทนี้</span>
                            </div>
                        </div>
                        
                        <!-- ห้องเรียนพิเศษ (Online) -->
                        <div class="exam-type-card" onclick="toggleExamType('specialOnline')">
                            <div class="exam-type-icon text-purple-600">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <h3 class="font-bold text-base sm:text-lg">ห้องเรียนพิเศษ (Online)</h3>
                            <p class="exam-date">สอบวันอาทิตย์ที่ 21 ธันวาคม 2568</p>
                            <div class="mt-2 flex items-center">
                                <input type="checkbox" id="specialOnline-checkbox" class="mr-2" onchange="toggleExamType('specialOnline')">
                                <span class="text-sm sm:text-base">เลือกประเภทนี้</span>
                            </div>
                        </div>
                        
                        <!-- ห้องเรียนปกติ (Online) -->
                        <div class="exam-type-card" onclick="toggleExamType('normalOnline')">
                            <div class="exam-type-icon text-orange-600">
                                <i class="fas fa-globe"></i>
                            </div>
                            <h3 class="font-bold text-base sm:text-lg">ห้องเรียนปกติ (Online)</h3>
                            <p class="exam-date">สอบวันอาทิตย์ที่ 21 ธันวาคม 2568</p>
                            <div class="mt-2 flex items-center">
                                <input type="checkbox" id="normalOnline-checkbox" class="mr-2" onchange="toggleExamType('normalOnline')">
                                <span class="text-sm sm:text-base">เลือกประเภทนี้</span>
                            </div>
                        </div>
                    </div>
                    <div id="exam-type-error" class="text-red-600 text-sm mt-3 hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>กรุณาเลือกประเภทการสอบอย่างน้อย 1 ประเภท
                    </div>
                </div>
                
                <!-- กรอกคะแนนตามประเภทที่เลือก -->
                <div id="score-inputs-container">
                    <!-- คะแนนจะถูกเพิ่มที่นี่โดย JavaScript -->
                </div>
                
                <!-- ส่วนเป้าหมายการสอบเข้า -->
                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">เป้าหมายการสอบเข้า</h2>
                    <p class="text-gray-600 mb-4 text-sm sm:text-base" id="target-description">เลือกหลักสูตรที่ต้องการวิเคราะห์เปรียบเทียบกับคะแนนปี 2568</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <!-- เป้าหมายห้องเรียนพิเศษ -->
                        <div id="special-target-section">
                            <h3 class="font-semibold text-base sm:text-lg text-gray-800 mb-3">หลักสูตรห้องเรียนพิเศษ</h3>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="target-special-ep" class="mr-3" onchange="validateTargetSelection()">
                                    <span class="font-medium text-sm sm:text-base">EP (English Program)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="target-special-smte" class="mr-3" onchange="validateTargetSelection()">
                                    <span class="font-medium text-sm sm:text-base">SMTE (Science Math Technology and Environment)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="target-special-gm" class="mr-3" onchange="validateTargetSelection()">
                                    <span class="font-medium text-sm sm:text-base">GM (Gifted Math)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- เป้าหมายห้องเรียนปกติ -->
                        <div id="normal-target-section">
                            <h3 class="font-semibold text-base sm:text-lg text-gray-800 mb-3">หลักสูตรห้องเรียนปกติ</h3>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="target-normal-in" class="mr-3" onchange="validateTargetSelection()">
                                    <span class="font-medium text-sm sm:text-base">ในเขตพื้นที่บริการ</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="target-normal-out" class="mr-3" onchange="validateTargetSelection()">
                                    <span class="font-medium text-sm sm:text-base">นอกเขตพื้นที่บริการ</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ปุ่มส่งข้อมูล -->
                <div class="text-center mt-6 sm:mt-8">
                    <button id="submit-btn" class="btn btn-success" onclick="validateAndSubmitForm()">
                        <i class="fas fa-paper-plane mr-2"></i> ส่งข้อมูลคะแนน
                    </button>
                    <button id="save-local-btn" class="btn btn-secondary ml-2" onclick="saveToLocalStorage()">
                        <i class="fas fa-save mr-2"></i> บันทึกลงเครื่อง
                    </button>
                    <button id="load-local-btn" class="btn btn-primary ml-2" onclick="loadFromLocalStorage()">
                        <i class="fas fa-folder-open mr-2"></i> โหลดข้อมูลที่บันทึกไว้
                    </button>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800 text-sm sm:text-base">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span id="data-source-info">กำลังโหลดข้อมูลจาก Firebase...</span>
                </div>
                
                <!-- ตัวกรองข้อมูล Results -->
                <div class="flex flex-wrap justify-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                    <div>
                        <label for="results-filter-curriculum" class="block text-sm font-medium text-gray-700 mb-1">ประเภทหลักสูตร</label>
                        <select id="results-filter-curriculum" class="input-field text-sm" onchange="renderScoresTable()">
                            <option value="all">ทั้งหมด</option>
                            <option value="Special">ห้องเรียนพิเศษ</option>
                            <option value="Normal">ห้องเรียนปกติ</option>
                        </select>
                    </div>
                    <div>
                        <label for="results-filter-exam-type" class="block text-sm font-medium text-gray-700 mb-1">ประเภทการสอบ</label>
                        <select id="results-filter-exam-type" class="input-field text-sm" onchange="renderScoresTable()">
                            <option value="all">ทั้งหมด</option>
                            <option value="On-site">On-site</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div>
                        <label for="results-filter-grade" class="block text-sm font-medium text-gray-700 mb-1">ระดับชั้น</label>
                        <select id="results-filter-grade" class="input-field text-sm" onchange="renderScoresTable()">
                            <option value="all">ทั้งหมด</option>
                            <option value="grade4">ประถมศึกษาปีที่ 4</option>
                            <option value="grade5">ประถมศึกษาปีที่ 5</option>
                            <option value="grade6">ประถมศึกษาปีที่ 6</option>
                        </select>
                    </div>
                </div>
                
                <div id="loading-indicator" class="text-center py-6 sm:py-8">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-600">กำลังโหลดข้อมูลจาก Firebase...</p>
                </div>
                
                <div class="table-container border rounded-lg shadow-md">
                    <table class="w-full text-xs sm:text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">อันดับที่สอบได้</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">ชื่อ</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">ระดับชั้น</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">ประเภทสอบ</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4 text-right">คะแนนรวม</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">คณิต</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">วิทย์</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">อังกฤษ</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">ไทย</th>
                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">สังคม</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- ข้อมูลจะถูกโหลดโดย JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="text-center mt-4 sm:mt-6">
                    <button onclick="fetchScoresFromFirebase(true, true)" class="btn btn-secondary mr-2 mb-2">
                        <i class="fas fa-sync-alt mr-2"></i> โหลดข้อมูลใหม่
                    </button>
                </div>
            </div>
            
            <!-- ANALYSIS SECTION -->
            <div id="analysis-section" class="hidden">
                <div class="text-center max-w-6xl mx-auto">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-yellow-800 rounded-r-lg text-sm sm:text-base">
                        <h3 class="font-bold">วิเคราะห์คะแนนเปรียบเทียบคะแนนสอบ Pre-test กับคะแนนสอบเข้าจริง (ปี 2568)</h3>
                        <p>ระบบจะประมวลผลคะแนน Pre-test ของคุณ (จากหน้ากรอกข้อมูล) และเปรียบเทียบกับสถิติคะแนนสอบเข้าจริงปี 2568</p>
                    </div>
                    
                    <!-- แท็บสำหรับเลือกประเภทการวิเคราะห์ -->
                    <div id="analysis-tabs" class="flex flex-wrap justify-center mb-6">
                        <!-- แท็บจะถูกสร้างโดย JavaScript -->
                    </div>
                    
                    <!-- Container for text analysis results -->
                    <div id="analysis-results-container" class="text-left space-y-6 sm:space-y-8">
                        <div class="text-center py-6 sm:py-8 text-gray-500">
                            <i class="fas fa-info-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>
                            <p class="text-base sm:text-lg">ยังไม่มีข้อมูลสำหรับการวิเคราะห์</p>
                            <p class="text-sm mt-2">กรุณากรอกข้อมูลและเลือกเป้าหมายในหน้า "กรอกข้อมูล" ก่อน</p>
                        </div>
                    </div>

                    <!-- ปุ่มบันทึกและพิมพ์ -->
                    <div class="text-center mt-6 no-print">
                        <button id="save-analysis-btn" class="btn btn-primary mr-2" onclick="saveAnalysisAsPDF()">
                            <i class="fas fa-download mr-2"></i> บันทึกการวิเคราะห์เป็น PDF
                        </button>
                        <button id="print-analysis-btn" class="btn btn-secondary" onclick="printAnalysis()">
                            <i class="fas fa-print mr-2"></i> พิมพ์หน้านี้
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Admin Login Section -->
            <div id="admin-login-section" class="hidden">
                <div class="text-center max-w-4xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">ระบบจัดการข้อมูลสำหรับผู้ดูแลระบบ</h2>
                    
                    <div class="admin-login-form">
                        <h3 class="text-lg font-bold mb-4">เข้าสู่ระบบผู้ดูแล</h3>
                        <div class="mb-4">
                            <label for="admin-password" class="block text-gray-700 font-semibold mb-2">รหัสผ่าน</label>
                            <input type="password" id="admin-password" class="input-field" placeholder="กรอกรหัสผ่าน">
                        </div>
                        <button onclick="adminLogin()" class="btn btn-primary w-full">
                            <i class="fas fa-sign-in-alt mr-2"></i> เข้าสู่ระบบ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Admin Panel Section -->
            <div id="admin-panel-section" class="hidden">
                <div class="text-center max-w-6xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">แผงควบคุมผู้ดูแลระบบ</h2>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800 text-sm sm:text-base">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="admin-data-source-info">กำลังโหลดข้อมูลจาก Firebase...</span>
                    </div>
                    
                    <!-- ปุ่มจัดการข้อมูล - เพิ่มปุ่มลบข้อมูลทั้งหมด -->
                    <div class="flex flex-wrap justify-center gap-4 mb-6">
                        <button onclick="exportToExcel()" class="btn btn-success">
                            <i class="fas fa-file-excel mr-2"></i> Export to Excel
                        </button>
                        <button onclick="refreshAdminData()" class="btn btn-secondary">
                            <i class="fas fa-sync-alt mr-2"></i> โหลดข้อมูลใหม่
                        </button>
                        <!-- ปุ่มลบข้อมูลทั้งหมด -->
                        <button onclick="showDeleteAllConfirmation()" class="btn-delete-all">
                            <i class="fas fa-trash-alt mr-2"></i> ลบข้อมูลทั้งหมด
                        </button>
                    </div>
                    
                    <!-- สถิติ Admin -->
                    <div class="dashboard-grid mb-6">
                        <div class="dashboard-card text-center">
                            <div class="text-gray-500 text-sm font-semibold mb-2">จำนวนข้อมูลทั้งหมด</div>
                            <div class="stat-number text-blue-600" id="admin-total-records">0</div>
                            <div class="text-xs text-gray-500 mt-2">รายการ</div>
                        </div>
                        
                        <div class="dashboard-card text-center">
                            <div class="text-gray-500 text-sm font-semibold mb-2">ข้อมูลล่าสุด</div>
                            <div class="stat-number text-green-600" id="admin-latest-record">-</div>
                            <div class="text-xs text-gray-500 mt-2">วันที่บันทึก</div>
                        </div>
                    </div>
                    
                    <div id="admin-loading-indicator" class="text-center py-6 sm:py-8">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-gray-600">กำลังโหลดข้อมูลสำหรับการจัดการ...</p>
                    </div>
                    
                    <!-- ตารางข้อมูล Admin -->
                    <div class="table-container border rounded-lg shadow-md mb-6">
                        <table class="w-full text-xs sm:text-sm text-left text-gray-600 admin-table">
                            <thead class="text-xs text-white uppercase">
                                <tr>
                                    <th scope="col" class="py-3 px-4">วันที่บันทึก</th>
                                    <th scope="col" class="py-3 px-4">ชื่อ</th>
                                    <th scope="col" class="py-3 px-4">ระดับชั้น</th>
                                    <th scope="col" class="py-3 px-4">ประเภทสอบ</th>
                                    <th scope="col" class="py-3 px-4 text-right">คะแนนรวม</th>
                                    <th scope="col" class="py-3 px-4">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body">
                                <!-- ข้อมูลจะถูกโหลดโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Line OPC Section -->
        <div class="line-opc-section mx-4 sm:mx-6 mb-4 sm:mb-6">
            <div class="flex flex-col items-center">
                <div class="text-center mb-4">
                    <p class="text-base sm:text-lg font-semibold mb-2">🌟 รวบรวมข้อมูลและออกแบบระบบโดย ... ลุ้นสอวอไปด้วยกันนะ 🌟</p>
                    <p class="text-lg sm:text-xl font-bold">ครอบครัวยอดนารี❤️สตรีวิทยา</p>
                </div>
                <a href="https://line.me/ti/g2/ZRIN-ofnybH08hXhS6OYTfIMeKqvupT0Qzd44Q" 
                   target="_blank" class="btn btn-primary">
                    <i class="fab fa-line mr-2 text-xl"></i>
                    Line OPC
                </a>
                <p class="text-xs sm:text-sm mt-3 opacity-90">คลิกเพื่อเข้าร่วมกลุ่มไลน์ครอบครัวยอดนารี</p>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-4 sm:py-6 text-gray-500 text-xs sm:text-sm">
        <p>Developed for Satriwithaya Pre-test Takers | โดยลุ้นสอวอไปด้วยกันนะ</p>
    </footer>

    <script>
        // 🔥 Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFgpikjnnG-WX0cF_SYt3okVLZ3RJLcwQ",
            authDomain: "satriwit-project.firebaseapp.com",
            projectId: "satriwit-project",
            storageBucket: "satriwit-project.firebasestorage.app",
            messagingSenderId: "867567936913",
            appId: "1:867567936913:web:585829ad8ea23ece60e630"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ตัวแปรเก็บข้อมูล
        let allScores = [];
        let isDataFetched = false;
        let currentView = 'dashboard';
        let chartInstances = {};
        let isAdminLoggedIn = false;
        const ADMIN_PASSWORD = "satriwit2025"; // เปลี่ยนรหัสผ่านตามต้องการ

        // ข้อมูลคะแนนสอบจริงปี 2568 สำหรับการเปรียบเทียบ
        const comparisonData2024 = {
            'EP': {
                title: 'หลักสูตร EP (English Program)',
                max: 168.50,
                avg: 139.89,
                min: 119.17,
                fullScore: 200,
                chanceThresholds: { high: 145.00, medium: 130.00 },
                note: "คำนวณบนสมมุติฐานที่ได้คะแนนในส่วนสัมภาษณ์เต็ม 20 คะแนน"
            },
            'SMTE': {
                title: 'หลักสูตร SMTE',
                max: 77.25,
                avg: 58.58,
                min: 47.75,
                fullScore: 100,
                chanceThresholds: { high: 62.00, medium: 52.00 },
                note: "หลักสูตร SMTE ไม่สอบวิชาภาษาอังกฤษจึงไม่นำมาใช้ในการคำนวณ"
            },
            'GM': {
                title: 'หลักสูตร GM (Gifted Math)',
                max: 90.00,
                avg: 73.30,
                min: 66.00,
                fullScore: 110,
                chanceThresholds: { high: 75.00, medium: 68.00 },
                note: ""
            },
            'Normal_In': {
                title: 'หลักสูตรห้องเรียนปกติ (ในเขต)',
                max: 58.50,
                avg: 50.33,
                min: 41.00,
                fullScore: 100,
                chanceThresholds: { high: 53.00, medium: 45.00 },
                note: ""
            },
            'Normal_Out': {
                title: 'หลักสูตรห้องเรียนปกติ (นอกเขต)',
                max: 65.50,
                avg: 51.41,
                min: 44.00,
                fullScore: 100,
                chanceThresholds: { high: 54.00, medium: 47.00 },
                note: ""
            }
        };

        // ฟังก์ชันสำหรับสลับแท็บหลัก
        window.switchView = (view) => {
            currentView = view;
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('form-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('analysis-section').classList.add('hidden');
            document.getElementById('admin-login-section').classList.add('hidden');
            document.getElementById('admin-panel-section').classList.add('hidden');
            
            document.getElementById('tab-dashboard').classList.remove('active');
            document.getElementById('tab-form').classList.remove('active');
            document.getElementById('tab-results').classList.remove('active');
            document.getElementById('tab-analysis').classList.remove('active');
            document.getElementById('tab-admin').classList.remove('active');
            
            // แสดงปุ่มออกจากระบบ Admin เฉพาะเมื่อล็อกอินแล้ว
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            if (isAdminLoggedIn) {
                adminLogoutBtn.classList.remove('hidden');
            } else {
                adminLogoutBtn.classList.add('hidden');
            }
            
            // ตรวจสอบว่าผู้ใช้เป็น Admin หรือไม่
            if (view === 'admin-login' || view === 'admin-panel') {
                if (isAdminLoggedIn) {
                    document.getElementById('admin-panel-section').classList.remove('hidden');
                    document.getElementById('tab-admin').classList.add('active');
                    loadAdminData();
                } else {
                    document.getElementById('admin-login-section').classList.remove('hidden');
                    document.getElementById('tab-admin').classList.add('active');
                }
            } else {
                document.getElementById(`${view}-section`).classList.remove('hidden');
                document.getElementById(`tab-${view}`).classList.add('active');
            }
            
            const backBtn = document.getElementById('back-to-form-btn');
            if (view === 'results' || view === 'analysis') {
                backBtn.classList.remove('hidden');
                if (view === 'results') {
                    fetchScoresFromFirebase(true, false); 
                } else if (view === 'analysis') {
                    renderAnalysis();
                }
            } else if (view === 'dashboard') {
                backBtn.classList.add('hidden');
                renderFullDashboard();
            } else {
                backBtn.classList.add('hidden');
            }
        };

        // --- Dashboard Functions ---

        // ฟังก์ชันหลักในการแสดงผล Dashboard
        async function renderFullDashboard() {
            document.getElementById('dashboard-loading-indicator').classList.remove('hidden');
            document.getElementById('dashboard-charts-container').innerHTML = '';

            try {
                // 1. Fetch data if not already fetched
                if (!isDataFetched) {
                    await fetchScoresFromFirebase(false);
                }

                // 2. Get filter values
                const filters = {
                    curriculum: document.getElementById('dashboard-filter-curriculum').value,
                    grade: document.getElementById('dashboard-filter-grade').value
                };

                // 3. Process data (Filter and Calculate Stats)
                const stats = processDashboardData(filters);
                
                // 4. Update main stat cards
                updateMainStats(stats);

                // 5. Render charts based on calculated stats
                renderDashboardCharts(stats);

            } catch (error) {
                console.error('Error rendering full dashboard:', error);
                showMessage('ไม่สามารถโหลดข้อมูลแดชบอร์ดได้', 'error');
            } finally {
                document.getElementById('dashboard-loading-indicator').classList.add('hidden');
            }
        }

        // ฟังก์ชันสร้าง Object สถิติ
        function createStatsObject() {
            return {
                respondentIds: new Set(),
                scores: [], // For Min/Max/Avg
                gradeDistribution: { grade4: 0, grade5: 0, grade6: 0 },
                examTypeDistribution: { specialOnsite: 0, specialOnline: 0, normalOnsite: 0, normalOnline: 0 },
                byGrade: {
                    grade4: { scoresSpecial: [], scoresNormal: [], byTypeSpecial: { 'On-site': [], 'Online': [] }, byTypeNormal: { 'On-site': [], 'Online': [] } },
                    grade5: { scoresSpecial: [], scoresNormal: [], byTypeSpecial: { 'On-site': [], 'Online': [] }, byTypeNormal: { 'On-site': [], 'Online': [] } },
                    grade6: { scoresSpecial: [], scoresNormal: [], byTypeSpecial: { 'On-site': [], 'Online': [] }, byTypeNormal: { 'On-site': [], 'Online': [] } }
                }
            };
        }
        
        // ฟังก์ชันประมวลผลข้อมูล (กรองและคำนวณ)
        function processDashboardData(filters) {
            const stats = createStatsObject();
            
            allScores.forEach(userEntry => {
                const userGrade = userEntry.currentGrade;
                
                // 1. กรองตามระดับชั้น (User Level)
                const gradeMatch = (filters.grade === 'all' || userGrade === filters.grade);
                if (!gradeMatch) return;
                
                let userHasMatchingScore = false;

                Object.entries(userEntry.scores || {}).forEach(([examTypeKey, examScore]) => {
                    // 2. Ableitung des Lehrplans
                    const curriculum = examScore.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');
                    
                    // 3. กรองตามหลักสูตร (Exam Level)
                    const curriculumMatch = (filters.curriculum === 'all' || curriculum === filters.curriculum);
                    if (!curriculumMatch) return;

                    // ---- ถ้าผ่านการกรองทั้งหมด ----
                    userHasMatchingScore = true;
                    
                    // A. เพิ่มข้อมูลสำหรับสถิติรวม
                    stats.scores.push(examScore.totalScore);
                    if (stats.examTypeDistribution.hasOwnProperty(examTypeKey)) {
                        stats.examTypeDistribution[examTypeKey]++;
                    }
                    
                    // B. เพิ่มข้อมูลสำหรับสถิติรายระดับชั้น
                    if (stats.byGrade.hasOwnProperty(userGrade)) {
                        const gradeData = stats.byGrade[userGrade];
                        if (curriculum === 'Special') {
                            gradeData.scoresSpecial.push(examScore.totalScore);
                            if (gradeData.byTypeSpecial.hasOwnProperty(examScore.examType)) {
                                gradeData.byTypeSpecial[examScore.examType].push(examScore.totalScore);
                            }
                        } else {
                            gradeData.scoresNormal.push(examScore.totalScore);
                            if (gradeData.byTypeNormal.hasOwnProperty(examScore.examType)) {
                                gradeData.byTypeNormal[examScore.examType].push(examScore.totalScore);
                            }
                        }
                    }
                });
                
                // C. นับผู้ตอบ (หาก user นี้มีคะแนนที่ตรงกับการกรอง)
                if (userHasMatchingScore) {
                    stats.respondentIds.add(userEntry.id);
                    if (stats.gradeDistribution.hasOwnProperty(userGrade)) {
                        stats.gradeDistribution[userGrade]++;
                    }
                }
            });

            // 4. คำนวณสถิติสรุป
            const scoresArray = stats.scores;
            stats.totalRespondents = stats.respondentIds.size;
            stats.totalAverage = scoresArray.length > 0 ? scoresArray.reduce((a, b) => a + b, 0) / scoresArray.length : 0;
            stats.totalMax = scoresArray.length > 0 ? Math.max(...scoresArray) : 0;
            stats.totalMin = scoresArray.length > 0 ? Math.min(...scoresArray) : 0;

            return stats;
        }

        // ฟังก์ชันอัพเดทสถิติหลัก
        function updateMainStats(stats) {
            document.getElementById('total-respondents').textContent = stats.totalRespondents;
            document.getElementById('average-score').textContent = stats.totalAverage.toFixed(2);
            document.getElementById('max-score').textContent = stats.totalMax.toFixed(2);
            document.getElementById('min-score').textContent = stats.totalMin.toFixed(2);
        }

        // ฟังก์ชันแสดงกราฟใน Dashboard
        function renderDashboardCharts(stats) {
            const container = document.getElementById('dashboard-charts-container');
            container.innerHTML = ''; // Clear previous charts
            
            if (stats.totalRespondents === 0) {
                 container.innerHTML = `
                    <div class="text-center py-6 sm:py-8 text-gray-500">
                        <i class="fas fa-info-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>
                        <p class="text-base sm:text-lg">ไม่พบข้อมูลตามตัวกรองที่เลือก</p>
                    </div>
                `;
                return;
            }

            // 1. สร้างโครง HTML ทั้งหมดก่อน
            container.innerHTML = `
                <!-- ส่วนที่ 1: การกระจายตัว -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="chart-card">
                        <h3 class="chart-title">การกระจายตามระดับชั้น (ผู้ตอบ)</h3>
                        <div class="chart-container-improved">
                            <canvas id="dashboard-grade-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title">การกระจายตามประเภทการสอบ</h3>
                        <div class="chart-container-improved">
                            <canvas id="dashboard-exam-type-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- ส่วนที่ 2: สถิติคะแนนรวม (ที่กรองแล้ว) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="chart-card">
                        <h3 class="chart-title">สถิติพื้นฐานคะแนน (ที่กรองแล้ว)</h3>
                        <div class="chart-container-improved">
                            <canvas id="basic-stats-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title">การกระจายคะแนน (ที่กรองแล้ว)</h3>
                        <div class="chart-container-improved">
                            <canvas id="score-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ส่วนที่ 3: ผลคะแนนรายระดับชั้น -->
                <div class="chart-card">
                    <h3 class="chart-title">ผลคะแนนรายระดับชั้น (ที่กรองแล้ว)</h3>
                    <div id="grade-level-charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- กราฟรายระดับชั้นจะถูกวาดที่นี่ -->
                    </div>
                </div>
            `;

            // 2. วาดกราฟลงบน <canvas> ที่เตรียมไว้
            try {
                // ส่วนที่ 1
                createDashboardGradeChart(stats.gradeDistribution);
                createDashboardExamTypeChart(stats.examTypeDistribution);
                
                // ส่วนที่ 2
                createBasicStatsChart(stats);
                createScoreDistributionChart(stats.scores);

                // ส่วนที่ 3
                populateByGradeLevel(stats.byGrade); 

            } catch (chartError) {
                console.error("Chart rendering error:", chartError);
                container.innerHTML = `<div class="text-red-500">เกิดข้อผิดพลาดในการวาดกราฟ: ${chartError.message}</div>`;
            }
        }

        // ฟังก์ชันสร้างกราฟการกระจายตามระดับชั้น
        function createDashboardGradeChart(gradeDistribution) {
            const ctx = document.getElementById('dashboard-grade-chart').getContext('2d');
            
            if (chartInstances['dashboard-grade-chart']) {
                chartInstances['dashboard-grade-chart'].destroy();
            }
            
            chartInstances['dashboard-grade-chart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ประถมศึกษาปีที่ 4', 'ประถมศึกษาปีที่ 5', 'ประถมศึกษาปีที่ 6'],
                    datasets: [{
                        data: [
                            gradeDistribution.grade4,
                            gradeDistribution.grade5,
                            gradeDistribution.grade6
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // ฟังก์ชันสร้างกราฟการกระจายตามประเภทการสอบ
        function createDashboardExamTypeChart(examTypeDistribution) {
            const ctx = document.getElementById('dashboard-exam-type-chart').getContext('2d');
            
            if (chartInstances['dashboard-exam-type-chart']) {
                chartInstances['dashboard-exam-type-chart'].destroy();
            }
            
            chartInstances['dashboard-exam-type-chart'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['พิเศษ On-site', 'พิเศษ Online', 'ปกติ On-site', 'ปกติ Online'],
                    datasets: [{
                        data: [
                            examTypeDistribution.specialOnsite,
                            examTypeDistribution.specialOnline,
                            examTypeDistribution.normalOnsite,
                            examTypeDistribution.normalOnline
                        ],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ฟังก์ชันสร้างกราฟสถิติพื้นฐาน
        function createBasicStatsChart(stats) {
            const ctx = document.getElementById('basic-stats-chart').getContext('2d');
            
            if (chartInstances['basic-stats-chart']) {
                chartInstances['basic-stats-chart'].destroy();
            }
            
            chartInstances['basic-stats-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ต่ำสุด', 'สูงสุด', 'เฉลี่ย'],
                    datasets: [{
                        label: 'คะแนน',
                        data: [stats.totalMin, stats.totalMax, stats.totalAverage],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'คะแนน: ' + context.raw.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'คะแนน' } } }
                }
            });
        }

        // ฟังก์ชันสร้างกราฟการกระจายคะแนน
        function createScoreDistributionChart(totalScores) {
            const ctx = document.getElementById('score-distribution-chart').getContext('2d');
            
            if (chartInstances['score-distribution-chart']) {
                chartInstances['score-distribution-chart'].destroy();
            }

            if (totalScores.length === 0) return;
            
            const maxScore = Math.max(...totalScores);
            const minScore = Math.min(...totalScores);
            
            // กำหนดจำนวนช่วงคะแนนตามจำนวนข้อมูล
            let binCount = Math.min(10, Math.ceil(totalScores.length / 5));
            if (binCount < 5) binCount = 5;
            
            let binSize = (maxScore - minScore) / binCount;
            
            // ปรับขนาดช่วงคะแนนให้เหมาะสม
            if (binSize < 5) {
                binSize = 5;
            }
            
            // Ensure binSize is at least 1 to avoid infinite loops
            if (binSize < 1) {
                binSize = 1;
            }
            
            binCount = Math.ceil((maxScore - minScore) / binSize);
            if(binCount <= 0) binCount = 1;

            const bins = Array(binCount).fill(0);
            const labels = [];
            
            for (let i = 0; i < binCount; i++) {
                const binStart = Math.floor(minScore + i * binSize);
                const binEnd = Math.floor(binStart + binSize);
                labels.push(`${binStart}-${binEnd}`);
                
                bins[i] = totalScores.filter(score => 
                    score >= binStart && (i === binCount - 1 ? score <= binEnd : score < binEnd)
                ).length;
            }
            
            chartInstances['score-distribution-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'จำนวนผู้สอบ',
                        data: bins,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'จำนวนผู้สอบ' } },
                        x: { title: { display: true, text: 'ช่วงคะแนน' } }
                    }
                }
            });
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ยอย่างปลอดภัย
        function safeAverage(scoresArray) {
            if (scoresArray.length === 0) return 0;
            return scoresArray.reduce((a, b) => a + b, 0) / scoresArray.length;
        }

        // ฟังก์ชันวาดกราฟแนวโน้มคะแนนเฉลี่ย (ป.4 -> ป.6)
        function createTrendChart(containerId, gradeData) {
            const ctx = document.getElementById(containerId).getContext('2d');
            if (chartInstances[containerId]) {
                chartInstances[containerId].destroy();
            }

            // คำนวณค่าเฉลี่ยสำหรับแต่ละเส้น
            const avgSpecial = [
                safeAverage(gradeData.grade4.scoresSpecial),
                safeAverage(gradeData.grade5.scoresSpecial),
                safeAverage(gradeData.grade6.scoresSpecial)
            ];
            const avgNormal = [
                safeAverage(gradeData.grade4.scoresNormal),
                safeAverage(gradeData.grade5.scoresNormal),
                safeAverage(gradeData.grade6.scoresNormal)
            ];

            chartInstances[containerId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ป.4', 'ป.5', 'ป.6'],
                    datasets: [
                        {
                            label: 'ห้องเรียนพิเศษ',
                            data: avgSpecial,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'ห้องเรียนปกติ',
                            data: avgNormal,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'คะแนนเฉลี่ย' } }
                    }
                }
            });
        }
        
        // ฟังก์ชันวาดกราฟเปรียบเทียบรูปแบบสอบ (On-site vs Online)
        function createExamTypeComparisonChart(containerId, gradeData) {
            const ctx = document.getElementById(containerId).getContext('2d');
            if (chartInstances[containerId]) {
                chartInstances[containerId].destroy();
            }

            // คำนวณค่าเฉลี่ยสำหรับแต่ละแท่ง
            const avgSpecialOnsite = safeAverage(gradeData.byTypeSpecial['On-site']);
            const avgSpecialOnline = safeAverage(gradeData.byTypeSpecial['Online']);
            const avgNormalOnsite = safeAverage(gradeData.byTypeNormal['On-site']);
            const avgNormalOnline = safeAverage(gradeData.byTypeNormal['Online']);
            
            chartInstances[containerId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['On-site', 'Online'],
                    datasets: [
                        {
                            label: 'พิเศษ',
                            data: [avgSpecialOnsite, avgSpecialOnline],
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        },
                        {
                            label: 'ปกติ',
                            data: [avgNormalOnsite, avgNormalOnline],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'คะแนนเฉลี่ย' } }
                    },
                    // Grouped Bar Chart
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                }
            });
        }
        
        // ฟังก์ชันหลักในการวาดกราฟรายระดับชั้น
        function populateByGradeLevel(byGradeData) {
            const container = document.getElementById('grade-level-charts-container');
            if (!container) return;
            
            container.innerHTML = `
                <!-- กราฟแนวโน้ม -->
                <div class="chart-card">
                    <h4 class="chart-title text-base">แนวโน้มคะแนนเฉลี่ย (ป.4 → ป.6)</h4>
                    <div class="chart-container-improved">
                        <canvas id="grade-trend-chart"></canvas>
                    </div>
                </div>
                <!-- กราฟ ป.4 -->
                <div class="chart-card">
                    <h4 class="chart-title text-base">เปรียบเทียบรูปแบบสอบ (ป.4)</h4>
                    <div class="chart-container-improved">
                        <canvas id="grade4-comparison-chart"></canvas>
                    </div>
                </div>
                <!-- กราฟ ป.5 -->
                <div class="chart-card">
                    <h4 class="chart-title text-base">เปรียบเทียบรูปแบบสอบ (ป.5)</h4>
                    <div class="chart-container-improved">
                        <canvas id="grade5-comparison-chart"></canvas>
                    </div>
                </div>
                <!-- กราฟ ป.6 -->
                <div class="chart-card">
                    <h4 class="chart-title text-base">เปรียบเทียบรูปแบบสอบ (ป.6)</h4>
                    <div class="chart-container-improved">
                        <canvas id="grade6-comparison-chart"></canvas>
                    </div>
                </div>
            `;
            
            // วาดกราฟ
            createTrendChart('grade-trend-chart', byGradeData);
            createExamTypeComparisonChart('grade4-comparison-chart', byGradeData.grade4);
            createExamTypeComparisonChart('grade5-comparison-chart', byGradeData.grade5);
            createExamTypeComparisonChart('grade6-comparison-chart', byGradeData.grade6);
        }

        // --- End of Dashboard Functions ---

        // ฟังก์ชันเลือก/ยกเลิกเลือกประเภทการสอบ
        window.toggleExamType = (examType) => {
            const checkbox = document.getElementById(`${examType}-checkbox`);
            const card = checkbox.closest('.exam-type-card');
            
            // สลับสถานะการเลือก
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                card.classList.add('selected');
                createScoreInputs(examType);
            } else {
                card.classList.remove('selected');
                removeScoreInputs(examType);
            }
            
            // อัพเดทการแสดงผลส่วนเป้าหมาย
            updateTargetVisibility();
        };

        // ฟังก์ชันอัพเดทการแสดงผลส่วนเป้าหมาย
        function updateTargetVisibility() {
            const hasSpecial = document.getElementById('specialOnsite-checkbox').checked || 
                              document.getElementById('specialOnline-checkbox').checked;
            const hasNormal = document.getElementById('normalOnsite-checkbox').checked || 
                              document.getElementById('normalOnline-checkbox').checked;
            
            const specialSection = document.getElementById('special-target-section');
            const normalSection = document.getElementById('normal-target-section');
            const targetDescription = document.getElementById('target-description');
            
            if (hasSpecial && hasNormal) {
                specialSection.style.display = 'block';
                normalSection.style.display = 'block';
                targetDescription.textContent = 'เลือกหลักสูตรที่ต้องการวิเคราะห์เปรียบเทียบกับคะแนนปี 2568';
            } else if (hasSpecial) {
                specialSection.style.display = 'block';
                normalSection.style.display = 'none';
                targetDescription.textContent = 'เลือกหลักสูตรห้องเรียนพิเศษที่ต้องการวิเคราะห์เปรียบเทียบกับคะแนนปี 2568';
                
                // รีเซ็ตการเลือกเป้าหมายห้องเรียนปกติ
                document.getElementById('target-normal-in').checked = false;
                document.getElementById('target-normal-out').checked = false;
            } else if (hasNormal) {
                specialSection.style.display = 'none';
                normalSection.style.display = 'block';
                targetDescription.textContent = 'เลือกหลักสูตรห้องเรียนปกติที่ต้องการวิเคราะห์เปรียบเทียบกับคะแนนปี 2568';
                
                // รีเซ็ตการเลือกเป้าหมายห้องเรียนพิเศษ
                document.getElementById('target-special-ep').checked = false;
                document.getElementById('target-special-smte').checked = false;
                document.getElementById('target-special-gm').checked = false;
            } else {
                specialSection.style.display = 'block';
                normalSection.style.display = 'block';
                targetDescription.textContent = 'เลือกหลักสูตรที่ต้องการวิเคราะห์เปรียบเทียบกับคะแนนปี 2568';
            }
        }

        // ฟังก์ชันสร้างฟอร์มกรอกคะแนนตามประเภทที่เลือก
        function createScoreInputs(examType) {
            const container = document.getElementById('score-inputs-container');
            
            // ตรวจสอบว่ามีส่วนกรอกคะแนนอยู่แล้วหรือไม่
            if (document.getElementById(`${examType}-score-section`)) {
                return;
            }
            
            const examTypeData = getExamTypeData(examType);
            
            const scoreSection = document.createElement('div');
            scoreSection.id = `${examType}-score-section`;
            scoreSection.className = 'score-input-section';
            
            scoreSection.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800">${examTypeData.title}</h3>
                    <button class="btn btn-danger text-xs sm:text-sm" onclick="toggleExamType('${examType}')">
                        <i class="fas fa-times mr-1"></i> ลบ
                    </button>
                </div>
                <div class="mb-4">
                    <label for="${examType}-rank" class="block text-gray-700 font-semibold mb-2">อันดับที่ได้ <span class="text-red-600">*</span></label>
                    <input type="number" id="${examType}-rank" class="input-field w-full md:w-48" placeholder="กรอกอันดับ" min="1" required>
                    <div id="${examType}-rank-error" class="text-red-600 text-sm mt-1 hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>กรุณากรอกอันดับที่ได้
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    ${examTypeData.subjects.map(subject => `
                        <div>
                            <label for="${examType}-${subject.id}" class="block text-gray-700 font-semibold mb-2">${subject.name} <span class="text-red-600">*</span></label>
                            <div class="relative">
                                <input type="number" id="${examType}-${subject.id}" class="input-field w-full pr-16" 
                                       placeholder="0.00" min="0" max="${subject.maxScore}" step="0.01" required oninput="calculateTotalScore('${examType}')">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/${subject.maxScore}</span>
                            </div>
                            <div id="${examType}-${subject.id}-error" class="text-red-600 text-sm mt-1 hidden">
                                <i class="fas fa-exclamation-circle mr-1"></i>กรุณากรอกคะแนน${subject.name}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">คะแนนรวม:</span>
                        <span id="${examType}-total-score" class="text-xl sm:text-2xl font-bold text-blue-600">0.00</span>
                    </div>
                </div>
            `;
            
            container.appendChild(scoreSection);
        }

        // ฟังก์ชันลบฟอร์มกรอกคะแนน
        function removeScoreInputs(examType) {
            const scoreSection = document.getElementById(`${examType}-score-section`);
            if (scoreSection) {
                scoreSection.remove();
            }
        }

        // ฟังก์ชันคำนวณคะแนนรวม
        window.calculateTotalScore = (examType) => {
            const examTypeData = getExamTypeData(examType);
            let total = 0;
            
            examTypeData.subjects.forEach(subject => {
                const scoreInput = document.getElementById(`${examType}-${subject.id}`);
                const scoreValue = parseFloat(scoreInput.value) || 0;
                total += scoreValue;
            });
            
            document.getElementById(`${examType}-total-score`).textContent = total.toFixed(2);
        };

        // ฟังก์ชันดึงข้อมูลประเภทการสอบ
        function getExamTypeData(examType) {
            const examTypes = {
                'specialOnsite': {
                    title: 'คะแนนห้องเรียนพิเศษ (On-site)',
                    examType: 'On-site',
                    curriculum: 'Special',
                    subjects: [
                        { id: 'math', name: 'คณิตศาสตร์', maxScore: 50 },
                        { id: 'science', name: 'วิทยาศาสตร์', maxScore: 30 },
                        { id: 'english', name: 'ภาษาอังกฤษ', maxScore: 30 }
                    ]
                },
                'normalOnsite': {
                    title: 'คะแนนห้องเรียนปกติ (On-site)',
                    examType: 'On-site',
                    curriculum: 'Normal',
                    subjects: [
                        { id: 'math', name: 'คณิตศาสตร์', maxScore: 30 },
                        { id: 'science', name: 'วิทยาศาสตร์', maxScore: 30 },
                        { id: 'english', name: 'ภาษาอังกฤษ', maxScore: 30 },
                        { id: 'thai', name: 'ภาษาไทย', maxScore: 30 },
                        { id: 'social', name: 'สังคมศึกษา', maxScore: 30 }
                    ]
                },
                'specialOnline': {
                    title: 'คะแนนห้องเรียนพิเศษ (Online)',
                    examType: 'Online',
                    curriculum: 'Special',
                    subjects: [
                        { id: 'math', name: 'คณิตศาสตร์', maxScore: 50 },
                        { id: 'science', name: 'วิทยาศาสตร์', maxScore: 30 },
                        { id: 'english', name: 'ภาษาอังกฤษ', maxScore: 30 }
                    ]
                },
                'normalOnline': {
                    title: 'คะแนนห้องเรียนปกติ (Online)',
                    examType: 'Online',
                    curriculum: 'Normal',
                    subjects: [
                        { id: 'math', name: 'คณิตศาสตร์', maxScore: 30 },
                        { id: 'science', name: 'วิทยาศาสตร์', maxScore: 30 },
                        { id: 'english', name: 'ภาษาอังกฤษ', maxScore: 30 },
                        { id: 'thai', name: 'ภาษาไทย', maxScore: 30 },
                        { id: 'social', name: 'สังคมศึกษา', maxScore: 30 }
                    ]
                }
            };
            
            return examTypes[examType];
        }

        // ฟังก์ชันตรวจสอบความสอดคล้องของเป้าหมาย
        window.validateTargetSelection = () => {
            return true;
        };

        // ฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
        function validateForm() {
            let isValid = true;
            
            // ตรวจสอบระดับชั้น
            const currentGrade = document.getElementById('current-grade').value;
            if (!currentGrade) {
                document.getElementById('current-grade-error').classList.remove('hidden');
                document.getElementById('current-grade').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('current-grade-error').classList.add('hidden');
                document.getElementById('current-grade').classList.remove('error');
            }
            
            // ตรวจสอบว่ามีการเลือกประเภทการสอบอย่างน้อย 1 ประเภท
            const selectedExamTypes = [
                'specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'
            ].filter(type => document.getElementById(`${type}-checkbox`).checked);
            
            if (selectedExamTypes.length === 0) {
                document.getElementById('exam-type-error').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('exam-type-error').classList.add('hidden');
            }
            
            // ตรวจสอบข้อมูลในแต่ละประเภทการสอบที่เลือก
            selectedExamTypes.forEach(examType => {
                const examTypeData = getExamTypeData(examType);
                
                // ตรวจสอบอันดับ
                const rankInput = document.getElementById(`${examType}-rank`);
                if (!rankInput.value || rankInput.value < 1) {
                    document.getElementById(`${examType}-rank-error`).classList.remove('hidden');
                    rankInput.classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById(`${examType}-rank-error`).classList.add('hidden');
                    rankInput.classList.remove('error');
                }
                
                // ตรวจสอบคะแนนแต่ละวิชา
                examTypeData.subjects.forEach(subject => {
                    const scoreInput = document.getElementById(`${examType}-${subject.id}`);
                    if (scoreInput.value === '' || scoreInput.value < 0 || scoreInput.value > subject.maxScore) {
                        document.getElementById(`${examType}-${subject.id}-error`).classList.remove('hidden');
                        scoreInput.classList.add('error');
                        isValid = false;
                    } else {
                        document.getElementById(`${examType}-${subject.id}-error`).classList.add('hidden');
                        scoreInput.classList.remove('error');
                    }
                });
            });
            
            // ตรวจสอบว่ามีการเลือกเป้าหมายการสอบเข้าอย่างน้อย 1 รายการ
            const hasSpecialTarget = document.getElementById('target-special-ep').checked || 
                                  document.getElementById('target-special-smte').checked || 
                                  document.getElementById('target-special-gm').checked;
            
            const hasNormalTarget = document.getElementById('target-normal-in').checked || 
                                  document.getElementById('target-normal-out').checked;
            
            if (!hasSpecialTarget && !hasNormalTarget) {
                showMessage('กรุณาเลือกเป้าหมายการสอบเข้าอย่างน้อย 1 รายการ', 'error');
                isValid = false;
            }
            
            return isValid;
        }

        // ฟังก์ชันส่งข้อมูลแบบฟอร์ม - แก้ไขแล้ว (เปลี่ยนไปหน้า analysis อัตโนมัติ)
        window.validateAndSubmitForm = async function() {
            if (!validateForm()) {
                showMessage('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง', 'error');
                return;
            }
            
            const nickname = document.getElementById('nickname').value.trim() || 'ไม่ประสงค์ออกนาม';
            const currentGrade = document.getElementById('current-grade').value;
            
            // รวบรวมข้อมูลคะแนน
            const scoresData = {};
            const selectedExamTypes = [
                'specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'
            ].filter(type => document.getElementById(`${type}-checkbox`).checked);
            
            selectedExamTypes.forEach(examType => {
                const examTypeData = getExamTypeData(examType);
                const scores = {};
                let totalScore = 0;
                
                examTypeData.subjects.forEach(subject => {
                    const scoreValue = parseFloat(document.getElementById(`${examType}-${subject.id}`).value) || 0;
                    scores[subject.id] = scoreValue;
                    totalScore += scoreValue;
                });
                
                scoresData[examType] = {
                    examType: examTypeData.examType,
                    curriculum: examTypeData.curriculum,
                    rank: parseInt(document.getElementById(`${examType}-rank`).value) || 0,
                    scores: scores,
                    totalScore: totalScore
                };
            });
            
            // รวบรวมเป้าหมายการวิเคราะห์
            const targetSpecial = [];
            const targetNormal = [];
            
            if (document.getElementById('target-special-ep').checked) targetSpecial.push('EP');
            if (document.getElementById('target-special-smte').checked) targetSpecial.push('SMTE');
            if (document.getElementById('target-special-gm').checked) targetSpecial.push('GM');
            if (document.getElementById('target-normal-in').checked) targetNormal.push('Normal_In');
            if (document.getElementById('target-normal-out').checked) targetNormal.push('Normal_Out');
            
            try {
                // แสดง loading
                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังส่งข้อมูล...';
                document.getElementById('submit-btn').disabled = true;
                
                // บันทึกข้อมูลลง Firebase
                await db.collection('pretestScores').add({
                    nickname: nickname,
                    currentGrade: currentGrade,
                    scores: scoresData,
                    targetSpecial: targetSpecial,
                    targetNormal: targetNormal,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // ✅ แก้ไข: เปลี่ยนไปหน้า analysis โดยอัตโนมัติทันที
                showMessage('บันทึกข้อมูลสำเร็จ! กำลังเปลี่ยนไปหน้าวิเคราะห์...', 'success');
                isDataFetched = false;
                
                // บันทึกข้อมูลลง localStorage ด้วย
                saveToLocalStorage();
                
                // เปลี่ยนไปหน้า analysis
                switchView('analysis');
                
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
                
                // รีเซ็ตปุ่ม
                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ส่งข้อมูลคะแนน';
                document.getElementById('submit-btn').disabled = false;
            }
        };

        // ฟังก์ชันรีเซ็ตฟอร์ม
        window.resetForm = () => {
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('form-section').classList.remove('hidden');
            
            // รีเซ็ตฟอร์ม
            document.getElementById('nickname').value = '';
            document.getElementById('current-grade').value = '';
            document.getElementById('current-grade-error').classList.add('hidden');
            document.getElementById('current-grade').classList.remove('error');
            
            // รีเซ็ตการเลือกประเภทการสอบ
            ['specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'].forEach(type => {
                document.getElementById(`${type}-checkbox`).checked = false;
                document.getElementById(`${type}-checkbox`).closest('.exam-type-card').classList.remove('selected');
                removeScoreInputs(type);
            });
            
            // รีเซ็ตเป้าหมาย
            document.getElementById('target-special-ep').checked = false;
            document.getElementById('target-special-smte').checked = false;
            document.getElementById('target-special-gm').checked = false;
            document.getElementById('target-normal-in').checked = false;
            document.getElementById('target-normal-out').checked = false;
            
            // รีเซ็ตการแสดงผลส่วนเป้าหมาย
            updateTargetVisibility();
            
            // รีเซ็ตปุ่ม
            document.getElementById('submit-btn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ส่งข้อมูลคะแนน';
            document.getElementById('submit-btn').disabled = false;
        };

        // ฟังก์ชันแสดงข้อความ
        function showMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            const messageDiv = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                          type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                          'bg-blue-100 border-blue-400 text-blue-700';
            
            messageDiv.className = `p-4 mb-4 rounded-lg border ${bgColor} shadow-lg transition-all duration-300`;
            messageDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                        ${message}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            messageBox.appendChild(messageDiv);
            
            // ลบข้อความอัตโนมัติหลังจาก 5 วินาที
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // ฟังก์ชันทดสอบการเชื่อมต่อ
        window.testConnection = async () => {
            const statusElement = document.getElementById('connection-status-text');
            statusElement.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-2"></i> กำลังทดสอบการเชื่อมต่อ...';
            
            try {
                // ทดสอบโดยการดึงข้อมูล 1 ครั้ง
                const testQuery = await db.collection('pretestScores').limit(1).get();
                
                document.getElementById('connection-status').classList.remove('bg-yellow-50', 'border-yellow-400', 'text-yellow-800');
                document.getElementById('connection-status').classList.add('bg-green-50', 'border-green-400', 'text-green-800');
                statusElement.innerHTML = 
                    '<i class="fas fa-check-circle mr-2"></i>การเชื่อมต่อกับ Firebase ทำงานปกติ';
                showMessage('การเชื่อมต่อกับ Firebase ทำงานปกติ', 'success');
                
            } catch (error) {
                console.error('Connection test failed:', error);
                document.getElementById('connection-status').classList.remove('bg-yellow-50', 'border-yellow-400', 'text-yellow-800');
                document.getElementById('connection-status').classList.add('bg-red-50', 'border-red-400', 'text-red-800');
                statusElement.innerHTML = 
                    '<i class="fas fa-times-circle mr-2"></i>ไม่สามารถเชื่อมต่อกับ Firebase ได้: ' + error.message;
                showMessage('ไม่สามารถเชื่อมต่อกับ Firebase ได้', 'error');
            }
        };

        // ฟังก์ชันดึงข้อมูลจาก Firebase
        async function fetchScoresFromFirebase(renderTable = true, forceFetch = false) {
            if (isDataFetched && renderTable && !forceFetch) {
                document.getElementById('data-source-info').innerHTML = 
                        '<i class="fas fa-cloud mr-2"></i>แสดงข้อมูลจาก Cache (' + allScores.length + ' รายการ) - อัปเดตล่าสุด: ' + new Date().toLocaleTimeString('th-TH');
                renderScoresTable();
                return;
            }
            if (isDataFetched && !renderTable && !forceFetch) {
                 return;
            }

            try {
                if(renderTable) {
                    document.getElementById('loading-indicator').classList.remove('hidden');
                    document.getElementById('results-table-body').innerHTML = '';
                    showMessage('กำลังโหลดข้อมูลจาก Firebase...', 'info');
                }
                
                const querySnapshot = await db.collection('pretestScores')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                allScores = scores;
                isDataFetched = true;
                
                if(renderTable) {
                    document.getElementById('data-source-info').innerHTML = 
                        '<i class="fas fa-cloud mr-2"></i>แสดงข้อมูลจาก Firebase (' + allScores.length + ' รายการ) - อัปเดตล่าสุด: ' + new Date().toLocaleTimeString('th-TH');
                    
                    showMessage('โหลดข้อมูลจาก Firebase สำเร็จ! (' + allScores.length + ' รายการ)', 'success');
                    renderScoresTable();
                }
                
            } catch (error) {
                console.error('Error fetching from Firebase:', error);
                isDataFetched = false;
                if(renderTable) {
                    showMessage('ไม่สามารถโหลดข้อมูลจาก Firebase ได้: ' + error.message, 'error');
                    document.getElementById('data-source-info').innerHTML = 
                        '<i class="fas fa-exclamation-triangle mr-2"></i>ไม่สามารถโหลดข้อมูลจาก Firebase ได้';
                }
            } finally {
                 if(renderTable) {
                    document.getElementById('loading-indicator').classList.add('hidden');
                 }
            }
        }

        // ฟังก์ชันแสดงตารางผลลัพธ์
        function renderScoresTable() {
            const tableBody = document.getElementById('results-table-body');
            
            if (!tableBody) return;
            
            if (allScores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-6 text-gray-500">ไม่มีข้อมูลในระบบ</td></tr>';
                return;
            }
            
            // รับค่าตัวกรอง
            const curriculumFilter = document.getElementById('results-filter-curriculum').value;
            const gradeFilter = document.getElementById('results-filter-grade').value;
            const examTypeFilter = document.getElementById('results-filter-exam-type').value;
            
            // 1. สร้าง list ของข้อสอบทั้งหมดก่อน
            let allExamScores = [];
            allScores.forEach(score => {
                
                Object.entries(score.scores || {}).forEach(([examTypeKey, examScore]) => {
                    
                    const scoresData = examScore.scores || {};

                    const curriculum = examScore.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');
                    const examType = examScore.examType || (examTypeKey.includes('Online') ? 'Online' : 'On-site');

                    allExamScores.push({
                        nickname: score.nickname,
                        currentGrade: score.currentGrade,
                        examType: examType,
                        curriculum: curriculum,
                        rank: examScore.rank,
                        totalScore: examScore.totalScore,
                        scores: {
                            math: scoresData.math || 0,
                            science: scoresData.science || 0,
                            english: scoresData.english || 0,
                            thai: scoresData.thai || 0,
                            social: scoresData.social || 0
                        }
                    });
                });
            });

            // 2. กรอง List ที่สร้างขึ้น
            const filteredExamScores = allExamScores.filter(exam => {
                const gradeMatch = (gradeFilter === 'all') || (exam.currentGrade === gradeFilter);
                const curriculumMatch = (curriculumFilter === 'all') || (exam.curriculum === curriculumFilter);
                const examTypeMatch = (examTypeFilter === 'all') || (exam.examType === examTypeFilter);
                
                return gradeMatch && curriculumMatch && examTypeMatch;
            });

            
            // เรียงลำดับตามอันดับที่สอบได้ (น้อยไปมาก) และหากอันดับเท่ากันให้เรียงตามคะแนนรวม (มากไปน้อย)
            filteredExamScores.sort((a, b) => {
                if (a.rank !== b.rank) {
                    return a.rank - b.rank;
                } else {
                    return b.totalScore - a.totalScore;
                }
            });
            
            let rows = '';

            // 3. แสดงผลตารางจาก List ที่กรองแล้ว
            if (filteredExamScores.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-6 text-gray-500">ไม่พบข้อมูลตามตัวกรองที่เลือก</td></tr>';
                 return;
            }
            
            filteredExamScores.forEach((examScore, index) => {
                const gradeText = getGradeText(examScore.currentGrade);
                
                rows += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="py-2 px-2 sm:py-3 sm:px-4 font-bold text-gray-900">${examScore.rank}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.nickname}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${gradeText}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${examScore.examType === 'On-site' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${examScore.curriculum === 'Special' ? 'พิเศษ' : 'ปกติ'} ${examScore.examType}
                            </span>
                        </td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4 text-right font-bold text-blue-600">${examScore.totalScore.toFixed(2)}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.math ? examScore.scores.math.toFixed(2) : '-'}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.science ? examScore.scores.science.toFixed(2) : '-'}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.english ? examScore.scores.english.toFixed(2) : '-'}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.thai ? examScore.scores.thai.toFixed(2) : '-'}</td>
                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.social ? examScore.scores.social.toFixed(2) : '-'}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = rows;
        }

        // ฟังก์ชันแปลงรหัสระดับชั้นเป็นข้อความ
        function getGradeText(gradeCode) {
            const gradeMap = {
                'grade4': 'ป.4',
                'grade5': 'ป.5', 
                'grade6': 'ป.6'
            };
            return gradeMap[gradeCode] || gradeCode;
        }

        // --- ANALYSIS FUNCTIONS ---
        
        // ฟังก์ชันแสดงผลการวิเคราะห์
        function renderAnalysis() {
            const container = document.getElementById('analysis-results-container');
            const tabsContainer = document.getElementById('analysis-tabs');
            container.innerHTML = '';
            tabsContainer.innerHTML = '';
            
            // 1. รวบรวมประเภทการสอบที่กรอก
            const selectedExamTypes = [
                'specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'
            ].filter(type => document.getElementById(`${type}-checkbox`).checked);

            if (selectedExamTypes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 sm:py-8 text-gray-500">
                        <i class="fas fa-info-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>
                        <p class="text-base sm:text-lg">ยังไม่มีข้อมูลสำหรับการวิเคราะห์</p>
                        <p class="text-sm mt-2">กรุณากรอกข้อมูลและเลือกเป้าหมายในหน้า "กรอกข้อมูล" ก่อน</p>
                    </div>
                `;
                return;
            }

            // 2. รวบรวมเป้าหมายที่เลือก
            const selectedTargets = {
                Special: [],
                Normal: []
            };
            if (document.getElementById('target-special-ep').checked) selectedTargets.Special.push('EP');
            if (document.getElementById('target-special-smte').checked) selectedTargets.Special.push('SMTE');
            if (document.getElementById('target-special-gm').checked) selectedTargets.Special.push('GM');
            if (document.getElementById('target-normal-in').checked) selectedTargets.Normal.push('Normal_In');
            if (document.getElementById('target-normal-out').checked) selectedTargets.Normal.push('Normal_Out');
            
            // 3. สร้างแท็บตามประเภทการสอบที่เลือก
            let analysisData = {};
            let hasAnalysisData = false;
            
            selectedExamTypes.forEach(examType => {
                const examTypeData = getExamTypeData(examType);
                const preTestTotal = parseFloat(document.getElementById(`${examType}-total-score`).textContent) || 0;
                
                // ดึงคะแนนดิบจากฟอร์ม
                const currentScores = {};
                examTypeData.subjects.forEach(subject => {
                    currentScores[subject.id] = parseFloat(document.getElementById(`${examType}-${subject.id}`).value) || 0;
                });
                
                // 4. จับคู่การสอบกับเป้าหมายที่ตรงกัน
                const targetsToAnalyze = (examTypeData.curriculum === 'Special') ? selectedTargets.Special : selectedTargets.Normal;
                
                targetsToAnalyze.forEach(target => {
                    const stats = comparisonData2024[target];
                    
                    if (stats) {
                        // 5. คำนวณคะแนน
                        const analysisResult = calculateRealExamScore(currentScores, target, examType);
                        
                        // เก็บข้อมูลสำหรับแท็บ
                        const tabKey = `${examTypeData.curriculum}_${examTypeData.examType}_${target}`;
                        analysisData[tabKey] = {
                            stats: stats,
                            projectedScore: analysisResult.projectedScore,
                            target: target,
                            preTestTotal: preTestTotal,
                            currentScores: currentScores,
                            examType: examType,
                            projectedSubjects: analysisResult.projectedSubjects,
                            curriculum: examTypeData.curriculum,
                            examMode: examTypeData.examType,
                            title: `${examTypeData.title} - ${stats.title}`
                        };
                        
                        hasAnalysisData = true;
                    }
                });
            });

            if (!hasAnalysisData) {
                container.innerHTML = `
                    <div class="text-center py-6 sm:py-8 text-gray-500">
                        <i class="fas fa-check-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>
                        <p class="text-base sm:text-lg">คุณกรอกข้อมูลเรียบร้อย</p>
                        <p class="text-sm mt-2">...แต่ยังไม่ได้เลือก "เป้าหมาย" ที่สอดคล้องกับการสอบที่คุณกรอกค่ะ</p>
                    </div>
                `;
                return;
            }

            // สร้างแท็บ
            let tabHTML = '';
            let contentHTML = '';
            let firstTab = true;
            
            Object.keys(analysisData).forEach((key, index) => {
                const data = analysisData[key];
                const tabId = `analysis-tab-${index}`;
                const contentId = `analysis-content-${index}`;
                
                tabHTML += `
                    <button id="${tabId}" class="analysis-tab ${firstTab ? 'active' : ''}" onclick="switchAnalysisTab('${tabId}', '${contentId}')">
                        ${data.title}
                    </button>
                `;
                
                contentHTML += `
                    <div id="${contentId}" class="analysis-tab-content ${firstTab ? 'active' : ''}">
                        ${createAnalysisCard(
                            data.stats, 
                            data.projectedScore, 
                            data.target, 
                            data.preTestTotal, 
                            data.currentScores, 
                            data.examType,
                            data.projectedSubjects
                        )}
                    </div>
                `;
                
                firstTab = false;
            });
            
            tabsContainer.innerHTML = tabHTML;
            container.innerHTML = contentHTML;
        }

        // ฟังก์ชันสลับแท็บวิเคราะห์
        window.switchAnalysisTab = (tabId, contentId) => {
            document.querySelectorAll('.analysis-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.getElementById(contentId).classList.add('active');
        };

        // ฟังก์ชันคำนวณคะแนนสอบจริง
        function calculateRealExamScore(preTestScores, targetCurriculum, examType) {
            let projectedScore = 0;
            let projectedSubjects = {};
            
            const isSpecialForm = examType.includes('special');
            
            const mathPre = preTestScores.math || 0;
            const sciPre = preTestScores.science || 0;
            const engPre = preTestScores.english || 0;
            const thaiPre = preTestScores.thai || 0;
            const socialPre = preTestScores.social || 0;
            
            const mathMax = isSpecialForm ? 50 : 30;
            const sciMax = 30;
            const engMax = 30;
            const thaiMax = 30;
            const socialMax = 30;
            
            switch (targetCurriculum) {
                case 'EP':
                    projectedSubjects.math = (mathPre / mathMax) * 50;
                    projectedSubjects.science = (sciPre / sciMax) * 50;
                    projectedSubjects.english = (engPre / engMax) * 80;
                    projectedSubjects.interview = 20;
                    
                    projectedScore = projectedSubjects.math + projectedSubjects.science + projectedSubjects.english + projectedSubjects.interview;
                    break;
                case 'GM':
                    projectedSubjects.math = (mathPre / mathMax) * 50;
                    projectedSubjects.science = (sciPre / sciMax) * 50;
                    projectedSubjects.english = (engPre / engMax) * 10;
                    
                    projectedScore = projectedSubjects.math + projectedSubjects.science + projectedSubjects.english;
                    break;
                case 'SMTE':
                    projectedSubjects.math = (mathPre / mathMax) * 50;
                    projectedSubjects.science = (sciPre / sciMax) * 50;
                    
                    projectedScore = projectedSubjects.math + projectedSubjects.science;
                    break;
                case 'Normal_In':
                case 'Normal_Out':
                    projectedSubjects.math = (mathPre / mathMax) * 20;
                    projectedSubjects.science = (sciPre / sciMax) * 20;
                    projectedSubjects.english = (engPre / engMax) * 20;
                    projectedSubjects.thai = (thaiPre / thaiMax) * 20;
                    projectedSubjects.social = (socialPre / socialMax) * 20;
                    
                    projectedScore = projectedSubjects.math + projectedSubjects.science + projectedSubjects.english + projectedSubjects.thai + projectedSubjects.social;
                    break;
            }
            
            return { projectedScore, projectedSubjects };
        }

        // ฟังก์ชันคำนวณโอกาสสอบติด
        function calculateAdmissionChance(projectedScore, stats) {
            const { chanceThresholds } = stats;
            if (projectedScore >= chanceThresholds.high) {
                return { level: 'high', text: 'พร้อมมาก', description: 'ยอดเยี่ยมมากค่ะ! ตอนนี้อยู่ในจุดที่พร้อมมากแล้ว ขอแค่รักษาความมุ่งมั่นไว้ ผลสำเร็จอยู่ไม่ไกลแน่นอนนะคะ' };
            } else if (projectedScore >= chanceThresholds.medium) {
                return { level: 'medium', text: 'มีลุ้น', description: 'มีโอกาสดีค่ะ! ควรรักษาความตั้งใจและเสริมจุดแข็งอีกเล็กน้อย เพื่อให้ผลออกมาดีที่สุดนะคะ' };
            } else {
                return { level: 'low', text: 'ท้าทาย', description: 'มาพยายามด้วยกันอีกนิดนะคะ ถ้าฝึกฝนอย่างสม่ำเสมอ เพิ่มเวลาเตรียมตัวอีกนิด ความสำเร็จอยู่ไม่ไกลแน่นอนค่ะ 🌱' };
            }
        }

        // ฟังก์ชันวิเคราะห์จุดแข็ง/จุดที่ควรเสริม
        function analyzeStrengthsWeaknesses(preTestScores, targetCurriculum, examType) {
            const strengths = [];
            const weaknesses = [];
            const improvements = [];
            
            const isSpecialForm = examType.includes('special');
            
            if (targetCurriculum === 'EP' || targetCurriculum === 'GM' || targetCurriculum === 'SMTE') {
                if (preTestScores.math >= (isSpecialForm ? 40 : 25)) {
                    strengths.push('คณิตศาสตร์');
                } else if (preTestScores.math <= (isSpecialForm ? 25 : 15)) {
                    weaknesses.push('คณิตศาสตร์');
                    improvements.push('ฝึกทำโจทย์คณิตศาสตร์ที่ซับซ้อนมากขึ้น');
                }
                
                if (preTestScores.science >= 20) {
                    strengths.push('วิทยาศาสตร์');
                } else if (preTestScores.science <= 12) {
                    weaknesses.push('วิทยาศาสตร์');
                    improvements.push('ทบทวนเนื้อหาวิทยาศาสตร์และฝึกทำข้อสอบวิเคราะห์');
                }
                
                if (preTestScores.english >= 20) {
                    strengths.push('ภาษาอังกฤษ');
                } else if (preTestScores.english <= 12) {
                    weaknesses.push('ภาษาอังกฤษ');
                    improvements.push('เพิ่มพูนคำศัพท์และฝึกการอ่าน comprehension');
                }
            } else {
                const subjects = [
                    { name: 'คณิตศาสตร์', score: preTestScores.math, threshold: 20 },
                    { name: 'วิทยาศาสตร์', score: preTestScores.science, threshold: 20 },
                    { name: 'ภาษาอังกฤษ', score: preTestScores.english, threshold: 20 },
                    { name: 'ภาษาไทย', score: preTestScores.thai, threshold: 20 },
                    { name: 'สังคมศึกษา', score: preTestScores.social, threshold: 20 }
                ];
                
                subjects.forEach(subject => {
                    if (subject.score >= subject.threshold) {
                        strengths.push(subject.name);
                    } else if (subject.score <= 12) {
                        weaknesses.push(subject.name);
                        improvements.push(`ทบทวนเนื้อหา${subject.name}และฝึกทำข้อสอบนะคะ`);
                    }
                });
            }
            
            return { strengths, weaknesses, improvements };
        }

        // ฟังก์ชันสร้างการ์ดแสดงผลการวิเคราะห์
        function createAnalysisCard(stats, projectedScore, target, preTestTotal, preTestScores, examType, projectedSubjects) {
            const { title, min, avg, max, fullScore } = stats;
            const scorePercent = Math.min(100, (projectedScore / fullScore * 100)).toFixed(2);
            const minPercent = (min / fullScore * 100);
            const avgPercent = (avg / fullScore * 100);
            const maxPercent = (max / fullScore * 100);
            
            const chance = calculateAdmissionChance(projectedScore, stats);
            const analysis = analyzeStrengthsWeaknesses(preTestScores, target, examType);

            let subjectTableHTML = '<table class="subject-table">';
            subjectTableHTML += '<thead><tr><th>วิชา</th><th>คะแนน Pre-test</th><th>คะแนนที่เทียบได้</th></tr></thead><tbody>';
            
            if (projectedSubjects.math !== undefined) {
                subjectTableHTML += `<tr><td>คณิตศาสตร์</td><td class="score-pretest">${preTestScores.math.toFixed(2)}</td><td class="score-projected">${projectedSubjects.math.toFixed(2)}</td></tr>`;
            }
            if (projectedSubjects.science !== undefined) {
                subjectTableHTML += `<tr><td>วิทยาศาสตร์</td><td class="score-pretest">${preTestScores.science.toFixed(2)}</td><td class="score-projected">${projectedSubjects.science.toFixed(2)}</td></tr>`;
            }
            if (projectedSubjects.english !== undefined) {
                subjectTableHTML += `<tr><td>ภาษาอังกฤษ</td><td class="score-pretest">${preTestScores.english.toFixed(2)}</td><td class="score-projected">${projectedSubjects.english.toFixed(2)}</td></tr>`;
            }
            if (projectedSubjects.thai !== undefined) {
                subjectTableHTML += `<tr><td>ภาษาไทย</td><td class="score-pretest">${preTestScores.thai.toFixed(2)}</td><td class="score-projected">${projectedSubjects.thai.toFixed(2)}</td></tr>`;
            }
            if (projectedSubjects.social !== undefined) {
                subjectTableHTML += `<tr><td>สังคมศึกษา</td><td class="score-pretest">${preTestScores.social.toFixed(2)}</td><td class="score-projected">${projectedSubjects.social.toFixed(2)}</td></tr>`;
            }
            if (projectedSubjects.interview !== undefined) {
                subjectTableHTML += `<tr><td>สัมภาษณ์ (สมมติฐาน)</td><td class="score-pretest">-</td><td class="score-projected">${projectedSubjects.interview.toFixed(2)}</td></tr>`;
            }
            subjectTableHTML += '</tbody></table>';

            
            return `
                <div class="border rounded-lg p-6 shadow-md bg-white">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-600">คะแนน Pre-test ของคุณ</p>
                            <p class="text-3xl font-extrabold text-blue-600">${preTestTotal.toFixed(2)}</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <p class="text-gray-600">คะแนนสอบจริงที่คาดการณ์</p>
                            <p class="text-3xl font-extrabold text-green-600">${projectedScore.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">จากเต็ม ${fullScore} คะแนน</p>
                        </div>
                    </div>
                    
                    <!-- ตารางเปรียบเทียบรายวิชา -->
                    ${subjectTableHTML}
                    
                    <!-- แสดงโอกาสสอบติด -->
                    <div class="mb-6 p-4 rounded-lg text-center text-white ${chance.level === 'high' ? 'chance-high' : chance.level === 'medium' ? 'chance-medium' : 'chance-low'}">
                        <h4 class="text-lg font-bold mb-2">โอกาสสอบติด: ${chance.text}</h4>
                        <p class="text-sm">${chance.description}</p>
                    </div>
                    
                    ${target === 'EP' ? 
                        `<div class="text-sm text-center bg-orange-100 text-orange-700 p-2 rounded-md mb-6">
                            <b>*หมายเหตุ:</b> คะแนนนี้คำนวณโดยสมมติว่าคุณได้คะแนนส่วนสัมภาษณ์เต็ม 20 คะแนน
                        </div>` : ''
                    }
                    
                    <!-- กราฟแท่งเปรียบเทียบ -->
                    <p class="text-sm font-semibold text-gray-700 mb-2">เปรียบเทียบกับสถิติปี 2568</p>
                    <div class="relative h-8 bg-gray-200 rounded-full mb-4 w-full" style="margin-top: 2.5rem;">
                        <div class="absolute h-full bg-gradient-to-r from-red-400 via-yellow-400 to-green-400 rounded-full" style="width:100%;"></div>
                        
                        <!-- Min marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${minPercent}%;">
                            <div class="w-1 h-10 bg-red-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">ต่ำสุด</span>
                        </div>
                        
                        <!-- Avg marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${avgPercent}%;">
                            <div class="w-1 h-10 bg-yellow-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded">เฉลี่ย</span>
                        </div>
                        
                        <!-- Max marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${maxPercent}%;">
                            <div class="w-1 h-10 bg-green-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded">สูงสุด</span>
                        </div>
                        
                        <!-- User score marker -->
                        <div class="absolute top-0 h-full flex items-center" style="left: ${scorePercent}%;">
                            <div class="w-1 h-10 bg-indigo-600 -translate-x-1/2"></div>
                            <span class="absolute -top-6 -translate-x-1/2 bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded">คุณ</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-600 px-1">
                        <span>0</span>
                        <span>${fullScore}</span>
                    </div>
                    
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-red-50 p-3 rounded-lg">
                            <p class="font-semibold text-red-600">ต่ำสุดปี 68</p>
                            <p class="text-2xl font-bold">${min.toFixed(2)}</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="font-semibold text-yellow-600">เฉลี่ยปี 68</p>
                            <p class="text-2xl font-bold">${avg.toFixed(2)}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="font-semibold text-green-600">สูงสุดปี 68</p>
                            <p class="text-2xl font-bold">${max.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <!-- แสดงจุดแข็งจุดอ่อน -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${analysis.strengths.length > 0 ? `
                            <div class="strength-item p-4 rounded-lg">
                                <h5 class="font-bold text-green-700 mb-2">จุดแข็ง</h5>
                                <ul class="text-sm space-y-1">
                                    ${analysis.strengths.map(strength => `<li>✓ ${strength}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${analysis.weaknesses.length > 0 ? `
                            <div class="weakness-item p-4 rounded-lg">
                                <h5 class="font-bold text-yellow-700 mb-2">จุดที่ควรเสริม</h5>
                                <ul class="text-sm space-y-1">
                                    ${analysis.weaknesses.map(weakness => `<li>✗ ${weakness}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${analysis.improvements.length > 0 ? `
                            <div class="improvement-item p-4 rounded-lg">
                                <h5 class="font-bold text-blue-700 mb-2">ข้อแนะนำ</h5>
                                <ul class="text-sm space-y-1">
                                    ${analysis.improvements.map(improvement => `<li>💡 ${improvement}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // --- Admin Functions ---

        // ฟังก์ชันล็อกอิน Admin
        window.adminLogin = () => {
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                showMessage('เข้าสู่ระบบผู้ดูแลสำเร็จ', 'success');
                switchView('admin-panel');
            } else {
                showMessage('รหัสผ่านไม่ถูกต้อง', 'error');
                document.getElementById('admin-password').value = '';
            }
        };

        // ฟังก์ชันออกจากระบบ Admin
        window.adminLogout = () => {
            isAdminLoggedIn = false;
            showMessage('ออกจากระบบผู้ดูแลเรียบร้อย', 'info');
            switchView('dashboard');
        };

        // ฟังก์ชันโหลดข้อมูลสำหรับ Admin
        async function loadAdminData() {
            try {
                document.getElementById('admin-loading-indicator').classList.remove('hidden');
                
                isDataFetched = false;
                await fetchScoresFromFirebase(false, true);
                
                document.getElementById('admin-total-records').textContent = allScores.length;
                
                if (allScores.length > 0) {
                    const latestRecord = allScores[0];
                    const timestamp = latestRecord.timestamp ? 
                        new Date(latestRecord.timestamp.seconds * 1000).toLocaleDateString('th-TH') : 
                        'ไม่ทราบวันที่';
                    document.getElementById('admin-latest-record').textContent = timestamp;
                }
                
                document.getElementById('admin-data-source-info').innerHTML = 
                    '<i class="fas fa-cloud mr-2"></i>แสดงข้อมูลจาก Firebase (' + allScores.length + ' รายการ) - อัปเดตล่าสุด: ' + new Date().toLocaleTimeString('th-TH');
                
                renderAdminTable();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showMessage('ไม่สามารถโหลดข้อมูลสำหรับการจัดการได้: ' + error.message, 'error');
            } finally {
                document.getElementById('admin-loading-indicator').classList.add('hidden');
            }
        }

        // ฟังก์ชันรีเฟรชข้อมูล Admin
        window.refreshAdminData = () => {
            loadAdminData();
        };

        // ฟังก์ชันแสดงตารางข้อมูลสำหรับ Admin
        function renderAdminTable() {
            const tableBody = document.getElementById('admin-table-body');
            
            if (!tableBody) return;
            
            if (allScores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-500">ไม่มีข้อมูลในระบบ</td></tr>';
                return;
            }
            
            let rows = '';
            
            allScores.forEach(score => {
                const timestamp = score.timestamp ? 
                    new Date(score.timestamp.seconds * 1000).toLocaleDateString('th-TH') + ' ' + 
                    new Date(score.timestamp.seconds * 1000).toLocaleTimeString('th-TH') : 
                    'ไม่ทราบวันที่';
                
                const examEntries = Object.entries(score.scores || {});
                
                if (examEntries.length === 0) {
                     rows += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="py-3 px-4">${timestamp}</td>
                            <td class="py-3 px-4">${score.nickname}</td>
                            <td class="py-3 px-4">${getGradeText(score.currentGrade)}</td>
                            <td class="py-3 px-4 text-red-500">ไม่มีข้อมูลคะแนน</td>
                            <td class="py-3 px-4 text-right">-</td>
                            <td class="py-3 px-4">
                                <button onclick="deleteRecord('${score.id}')" class="delete-btn">
                                    <i class="fas fa-trash mr-1"></i> ลบ
                                </button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                examEntries.forEach(([examTypeKey, examData], index) => {
                    const curriculum = examData.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');
                    const examType = examData.examType || (examTypeKey.includes('Online') ? 'Online' : 'On-site');
                    
                    rows += `
                        <tr class="bg-white border-b hover:bg-gray-50 ${index > 0 ? 'border-t-2 border-gray-300' : ''}">
                            <td class="py-3 px-4">${index === 0 ? timestamp : ''}</td>
                            <td class="py-3 px-4">${index === 0 ? score.nickname : ''}</td>
                            <td class="py-3 px-4">${index === 0 ? getGradeText(score.currentGrade) : ''}</td>
                            <td class="py-3 px-4">${curriculum} (${examType})</td>
                            <td class="py-3 px-4 text-right">${(examData.totalScore || 0).toFixed(2)}</td>
                            <td class="py-3 px-4">
                                ${index === 0 ? 
                                    `<button onclick="deleteRecord('${score.id}')" class="delete-btn">
                                        <i class="fas fa-trash mr-1"></i> ลบ
                                    </button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                });
            });
            
            tableBody.innerHTML = rows;
        }

        // ฟังก์ชันลบข้อมูล
        window.deleteRecord = async (recordId) => {
            if (!confirmDelete("หากต้องการลบ ให้พิมพ์ 'DELETE' แล้วกด OK")) {
                 showMessage('ยกเลิกการลบ', 'info');
                 return;
             }

            try {
                await db.collection('pretestScores').doc(recordId).delete();
                showMessage('ลบข้อมูลสำเร็จ', 'success');
                isDataFetched = false;
                loadAdminData();
            } catch (error) {
                console.error('Error deleting record:', error);
                showMessage('ไม่สามารถลบข้อมูลได้: ' + error.message, 'error');
            }
        };

        function confirmDelete(message) {
            try {
                return prompt(message) === 'DELETE';
            } catch (e) {
                console.warn("prompt() failed, possibly blocked. Defaulting to 'Cancel'.", e);
                showMessage("การยืนยันถูกบล็อก กรุณาพิมพ์ 'DELETE' ในช่องที่ปรากฏ (หากมี)", "error");
                return false;
            }
        }

        // ฟังก์ชันแสดง Modal ยืนยันการลบข้อมูลทั้งหมด
        window.showDeleteAllConfirmation = () => {
            document.getElementById('delete-all-modal').classList.remove('hidden');
            document.getElementById('delete-all-confirmation').value = '';
            document.getElementById('delete-all-confirmation').focus();
        };
        
        // ฟังก์ชันปิด Modal ยืนยันการลบข้อมูลทั้งหมด
        function closeDeleteAllModal() {
            document.getElementById('delete-all-modal').classList.add('hidden');
        }
        
        // ฟังก์ชันลบข้อมูลทั้งหมด
        async function deleteAllRecords() {
            try {
                showMessage('กำลังลบข้อมูลทั้งหมด...', 'info');
                
                const querySnapshot = await db.collection('pretestScores').get();
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(db.collection('pretestScores').doc(doc.id).delete());
                });
                
                await Promise.all(deletePromises);
                
                showMessage(`ลบข้อมูลทั้งหมด ${deletePromises.length} รายการสำเร็จ`, 'success');
                isDataFetched = false;
                loadAdminData();
                
            } catch (error) {
                console.error('Error deleting all records:', error);
                showMessage('ไม่สามารถลบข้อมูลทั้งหมดได้: ' + error.message, 'error');
            } finally {
                closeDeleteAllModal();
            }
        }
        
        // ฟังก์ชันส่งออกข้อมูลเป็น Excel
        window.exportToExcel = () => {
            if (allScores.length === 0) {
                showMessage('ไม่มีข้อมูลที่จะส่งออก', 'error');
                return;
            }
            
            try {
                const excelData = [];
                
                excelData.push([
                    'วันที่บันทึก', 'ชื่อ', 'ระดับชั้น', 'ประเภทสอบ (Key)', 'หลักสูตร (Derived)', 'รูปแบบสอบ (Derived)',
                    'อันดับ', 'คะแนนรวม', 'คณิตศาสตร์', 'วิทยาศาสตร์', 
                    'ภาษาอังกฤษ', 'ภาษาไทย', 'สังคมศึกษา', 'เป้าหมายพิเศษ', 'เป้าหมายปกติ', 'ID'
                ]);
                
                allScores.forEach(score => {
                    const timestamp = score.timestamp ? 
                        new Date(score.timestamp.seconds * 1000).toISOString() :
                        'ไม่ทราบวันที่';
                    
                    Object.entries(score.scores || {}).forEach(([examTypeKey, examData]) => {
                        
                        const curriculum = examData.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');
                        const examType = examData.examType || (examTypeKey.includes('Online') ? 'Online' : 'On-site');

                        const row = [
                            timestamp,
                            score.nickname,
                            getGradeText(score.currentGrade),
                            examTypeKey,
                            curriculum,
                            examType,
                            examData.rank || '',
                            examData.totalScore || '',
                            examData.scores?.math || '',
                            examData.scores?.science || '',
                            examData.scores?.english || '',
                            examData.scores?.thai || '',
                            examData.scores?.social || '',
                            score.targetSpecial?.join(', ') || '',
                            score.targetNormal?.join(', ') || '',
                            score.id
                        ];
                        excelData.push(row);
                    });
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                const colWidths = [
                    { wch: 20 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
                    { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                    { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 25 }
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'คะแนน Pre-test');
                
                const fileName = `satriwit-pretest-data-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage('ส่งออกข้อมูลเป็น Excel สำเร็จ', 'success');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showMessage('ไม่สามารถส่งออกข้อมูลได้: ' + error.message, 'error');
            }
        };

        // --- ฟังก์ชันสำหรับบันทึกและพิมพ์หน้าการวิเคราะห์ (แก้ไขใหม่) ---
        
        // ฟังก์ชันบันทึกการวิเคราะห์เป็น PDF - แก้ไขใหม่
        window.saveAnalysisAsPDF = async function() {
            try {
                // แสดงสถานะกำลังบันทึก
                document.getElementById('save-analysis-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังสร้าง PDF...';
                document.getElementById('save-analysis-btn').disabled = true;
                
                // รับแท็บการวิเคราะห์ที่กำลังแสดงอยู่
                const activeTabContent = document.querySelector('.analysis-tab-content.active');
                if (!activeTabContent) {
                    throw new Error('ไม่พบข้อมูลการวิเคราะห์ที่เลือก');
                }
                
                // สร้างสำเนาของเนื้อหาเพื่อป้องกันการเปลี่ยนแปลงขณะบันทึก
                const contentClone = activeTabContent.cloneNode(true);
                
                // ซ่อนปุ่มต่างๆ ในสำเนา
                const buttons = contentClone.querySelectorAll('button');
                buttons.forEach(btn => btn.style.display = 'none');
                
                // เพิ่มหัวข้อและวันที่
                const headerDiv = document.createElement('div');
                headerDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px;">
                        <h1 style="color: #3b82f6; margin: 0; font-size: 24px;">รายงานการวิเคราะห์คะแนน Pre-test</h1>
                        <h2 style="color: #6b7280; margin: 5px 0; font-size: 18px;">โรงเรียนสตรีวิทยา ปีการศึกษา 2569</h2>
                        <p style="color: #9ca3af; font-size: 14px;">สร้างเมื่อ: ${new Date().toLocaleDateString('th-TH', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                    </div>
                `;
                contentClone.insertBefore(headerDiv, contentClone.firstChild);
                
                // เพิ่มข้อมูลผู้ใช้
                const userInfoDiv = document.createElement('div');
                userInfoDiv.style.cssText = 'background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;';
                userInfoDiv.innerHTML = `
                    <h3 style="margin-top: 0; color: #374151; font-size: 16px;">ข้อมูลผู้วิเคราะห์</h3>
                    <p><strong>ชื่อ:</strong> ${document.getElementById('nickname').value || 'ไม่ระบุชื่อ'}</p>
                    <p><strong>ระดับชั้น:</strong> ${document.getElementById('current-grade').options[document.getElementById('current-grade').selectedIndex].text || 'ไม่ระบุ'}</p>
                `;
                contentClone.insertBefore(userInfoDiv, headerDiv.nextSibling);
                
                // เพิ่มหมายเหตุท้ายรายงาน
                const footerDiv = document.createElement('div');
                footerDiv.style.cssText = 'margin-top: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;';
                footerDiv.innerHTML = `
                    <p><strong>หมายเหตุ:</strong> การวิเคราะห์นี้เป็นการประเมินเบื้องต้นจากคะแนน Pre-test เท่านั้น 
                    และใช้ข้อมูลคะแนนสอบเข้าปี 2568 เป็นเกณฑ์เปรียบเทียบ</p>
                    <p>รายงานนี้สร้างโดยระบบสำรวจคะแนน Pre-test สตรีวิทยา 2569</p>
                `;
                contentClone.appendChild(footerDiv);
                
                // ปรับแต่งเนื้อหาให้เหมาะสมสำหรับ PDF
                contentClone.style.cssText = 'width: 210mm; padding: 20px; font-family: "Noto Sans Thai", sans-serif;';
                
                // ใช้ html2canvas เพื่อจับภาพหน้าเว็บ
                const canvas = await html2canvas(contentClone, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 794, // A4 width in pixels at 96 DPI
                    height: contentClone.scrollHeight * 2,
                    windowWidth: 794
                });
                
                // สร้าง PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                // ตรวจสอบความสูงของเนื้อหา
                let heightLeft = pdfHeight;
                let position = 0;
                
                // เพิ่มหน้าแรก
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
                
                // เพิ่มหน้าต่อไปหากเนื้อหายาวเกิน
                while (heightLeft >= 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }
                
                // บันทึกไฟล์
                const fileName = `รายงานวิเคราะห์คะแนน-สตรีวิทยา-${new Date().toISOString().slice(0, 10)}.pdf`;
                pdf.save(fileName);
                
                showMessage('บันทึกไฟล์ PDF สำเร็จ!', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message, 'error');
            } finally {
                // รีเซ็ตปุ่ม
                document.getElementById('save-analysis-btn').innerHTML = '<i class="fas fa-download mr-2"></i> บันทึกการวิเคราะห์เป็น PDF';
                document.getElementById('save-analysis-btn').disabled = false;
            }
        };

        // ฟังก์ชันพิมพ์หน้าการวิเคราะห์ - แก้ไขใหม่
        window.printAnalysis = function() {
            const activeTabContent = document.querySelector('.analysis-tab-content.active');
            if (!activeTabContent) {
                showMessage('ไม่พบข้อมูลการวิเคราะห์ที่เลือก', 'error');
                return;
            }
            
            // สร้างหน้าต่างพิมพ์
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>รายงานการวิเคราะห์คะแนน Pre-test สตรีวิทยา</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap');
                        
                        body {
                            font-family: 'Noto Sans Thai', sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 20px;
                            font-size: 12pt;
                            position: relative;
                        }
                        .print-watermark {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            pointer-events: none;
                            z-index: 9999;
                            opacity: 0.1;
                            background: transparent;
                        }
                        .print-watermark-text {
                            position: absolute;
                            color: #6b7280;
                            font-size: 20px;
                            font-weight: 500;
                            transform: rotate(-45deg);
                            white-space: nowrap;
                        }
                        .print-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #3b82f6;
                            padding-bottom: 15px;
                        }
                        .print-header h1 {
                            color: #3b82f6;
                            margin: 0;
                            font-size: 24pt;
                        }
                        .print-header h2 {
                            color: #6b7280;
                            margin: 5px 0;
                            font-size: 18pt;
                        }
                        .user-info {
                            background: #f3f4f6;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            font-size: 11pt;
                        }
                        .print-footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #e5e7eb;
                            font-size: 10pt;
                            color: #6b7280;
                        }
                        .analysis-content {
                            width: 100%;
                        }
                        .analysis-content table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            font-size: 10pt;
                        }
                        .analysis-content table, .analysis-content th, .analysis-content td {
                            border: 1px solid #000;
                        }
                        .analysis-content th, .analysis-content td {
                            padding: 8px;
                            text-align: center;
                        }
                        .analysis-content th {
                            background-color: #f9fafb;
                        }
                        @media print {
                            body { 
                                padding: 15px; 
                                margin: 0;
                                width: 100%;
                            }
                            .no-print { display: none !important; }
                            .page-break { page-break-before: always; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-watermark">
                        <div class="print-watermark-text" style="top: 30%; left: 10%;">ลุ้นสอวอไปด้วยกันนะ</div>
                        <div class="print-watermark-text" style="top: 60%; left: 60%;">ลุ้นสอวอไปด้วยกันนะ</div>
                        <div class="print-watermark-text" style="top: 80%; left: 20%;">ลุ้นสอวอไปด้วยกันนะ</div>
                    </div>
                    
                    <div class="print-header">
                        <h1>รายงานการวิเคราะห์คะแนน Pre-test</h1>
                        <h2>โรงเรียนสตรีวิทยา ปีการศึกษา 2569</h2>
                        <p>สร้างเมื่อ: ${new Date().toLocaleDateString('th-TH', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                    </div>
                    
                    <div class="user-info">
                        <h3>ข้อมูลผู้วิเคราะห์</h3>
                        <p><strong>ชื่อ:</strong> ${document.getElementById('nickname').value || 'ไม่ระบุชื่อ'}</p>
                        <p><strong>ระดับชั้น:</strong> ${document.getElementById('current-grade').options[document.getElementById('current-grade').selectedIndex].text || 'ไม่ระบุ'}</p>
                    </div>
                    
                    <div class="analysis-content">
                        ${activeTabContent.innerHTML}
                    </div>
                    
                    <div class="print-footer">
                        <p><strong>หมายเหตุ:</strong> การวิเคราะห์นี้เป็นการประเมินเบื้องต้นจากคะแนน Pre-test เท่านั้น 
                        และใช้ข้อมูลคะแนนสอบเข้าปี 2568 เป็นเกณฑ์เปรียบเทียบ</p>
                        <p>รายงานนี้สร้างโดยระบบสำรวจคะแนน Pre-test สตรีวิทยา 2569</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            พิมพ์หน้านี้
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            ปิดหน้าต่าง
                        </button>
                    </div>
                    
                    <script>
                        // ปรับขนาดฟอนต์และตารางให้พอดีกับหน้ากระดาษ
                        window.onload = function() {
                            const tables = document.querySelectorAll('table');
                            tables.forEach(table => {
                                table.style.fontSize = '10pt';
                            });
                            
                            const containers = document.querySelectorAll('.border.rounded-lg');
                            containers.forEach(container => {
                                container.style.border = '1px solid #000 !important';
                                container.style.boxShadow = 'none !important';
                            });
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        };

        // --- ฟังก์ชันสำหรับ Local Storage ---
        
        // ฟังก์ชันบันทึกข้อมูลลง Local Storage
        window.saveToLocalStorage = function() {
            try {
                // รวบรวมข้อมูลจากฟอร์ม
                const formData = {
                    nickname: document.getElementById('nickname').value,
                    currentGrade: document.getElementById('current-grade').value,
                    selectedExamTypes: [],
                    scores: {},
                    targets: {
                        special: [],
                        normal: []
                    }
                };
                
                // รวบรวมประเภทการสอบที่เลือก
                ['specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'].forEach(type => {
                    if (document.getElementById(`${type}-checkbox`).checked) {
                        formData.selectedExamTypes.push(type);
                        
                        // รวบรวมคะแนน
                        const examTypeData = getExamTypeData(type);
                        formData.scores[type] = {
                            rank: document.getElementById(`${type}-rank`).value,
                            subjects: {}
                        };
                        
                        examTypeData.subjects.forEach(subject => {
                            formData.scores[type].subjects[subject.id] = 
                                document.getElementById(`${type}-${subject.id}`).value;
                        });
                    }
                });
                
                // รวบรวมเป้าหมาย
                if (document.getElementById('target-special-ep').checked) formData.targets.special.push('EP');
                if (document.getElementById('target-special-smte').checked) formData.targets.special.push('SMTE');
                if (document.getElementById('target-special-gm').checked) formData.targets.special.push('GM');
                if (document.getElementById('target-normal-in').checked) formData.targets.normal.push('Normal_In');
                if (document.getElementById('target-normal-out').checked) formData.targets.normal.push('Normal_Out');
                
                // บันทึกลง Local Storage
                localStorage.setItem('satriwitPretestData', JSON.stringify(formData));
                localStorage.setItem('satriwitPretestTimestamp', new Date().toISOString());
                
                showMessage('บันทึกข้อมูลลงเครื่องสำเร็จ! คุณสามารถโหลดข้อมูลนี้ในภายหลังได้', 'success');
                
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูลลงเครื่อง', 'error');
            }
        };
        
        // ฟังก์ชันโหลดข้อมูลจาก Local Storage
        window.loadFromLocalStorage = function() {
            try {
                const savedData = localStorage.getItem('satriwitPretestData');
                const savedTimestamp = localStorage.getItem('satriwitPretestTimestamp');
                
                if (!savedData) {
                    showMessage('ไม่พบข้อมูลที่บันทึกไว้ในเครื่อง', 'info');
                    return;
                }
                
                const formData = JSON.parse(savedData);
                
                // โหลดข้อมูลพื้นฐาน
                document.getElementById('nickname').value = formData.nickname || '';
                document.getElementById('current-grade').value = formData.currentGrade || '';
                
                // โหลดประเภทการสอบ
                ['specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'].forEach(type => {
                    const checkbox = document.getElementById(`${type}-checkbox`);
                    const card = checkbox.closest('.exam-type-card');
                    
                    if (formData.selectedExamTypes.includes(type)) {
                        checkbox.checked = true;
                        card.classList.add('selected');
                        createScoreInputs(type);
                        
                        // โหลดคะแนน
                        if (formData.scores[type]) {
                            document.getElementById(`${type}-rank`).value = formData.scores[type].rank || '';
                            
                            const examTypeData = getExamTypeData(type);
                            examTypeData.subjects.forEach(subject => {
                                const input = document.getElementById(`${type}-${subject.id}`);
                                if (input && formData.scores[type].subjects[subject.id]) {
                                    input.value = formData.scores[type].subjects[subject.id];
                                }
                            });
                            
                            // คำนวณคะแนนรวมใหม่
                            calculateTotalScore(type);
                        }
                    } else {
                        checkbox.checked = false;
                        card.classList.remove('selected');
                        removeScoreInputs(type);
                    }
                });
                
                // โหลดเป้าหมาย
                document.getElementById('target-special-ep').checked = formData.targets.special.includes('EP');
                document.getElementById('target-special-smte').checked = formData.targets.special.includes('SMTE');
                document.getElementById('target-special-gm').checked = formData.targets.special.includes('GM');
                document.getElementById('target-normal-in').checked = formData.targets.normal.includes('Normal_In');
                document.getElementById('target-normal-out').checked = formData.targets.normal.includes('Normal_Out');
                
                // อัพเดทการแสดงผลส่วนเป้าหมาย
                updateTargetVisibility();
                
                const timestamp = savedTimestamp ? new Date(savedTimestamp).toLocaleString('th-TH') : 'ไม่ทราบเวลา';
                showMessage(`โหลดข้อมูลสำเร็จ! (บันทึกเมื่อ: ${timestamp})`, 'success');
                
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูลจากเครื่อง', 'error');
            }
        };

        // ฟังก์ชันสร้างลายน้ำ
        function createWatermark() {
            const watermark = document.getElementById('watermark');
            if (!watermark) return;
            
            // ล้างลายน้ำเดิม
            watermark.innerHTML = '';
            
            // สร้างลายน้ำหลายตำแหน่ง
            const positions = [
                { top: '20%', left: '10%' },
                { top: '40%', left: '60%' },
                { top: '70%', left: '30%' },
                { top: '80%', left: '70%' },
                { top: '30%', left: '80%' }
            ];
            
            positions.forEach(pos => {
                const watermarkText = document.createElement('div');
                watermarkText.className = 'watermark-text';
                watermarkText.style.top = pos.top;
                watermarkText.style.left = pos.left;
                watermarkText.textContent = 'ลุ้นสอวอไปด้วยกันนะ';
                watermark.appendChild(watermarkText);
            });
        }

        // ตั้งค่าเริ่มต้นเมื่อโหลดหน้าเว็บ
        document.addEventListener('DOMContentLoaded', function() {
            switchView('dashboard');
            testConnection();
            createWatermark();
            
            document.getElementById('confirm-delete-all').addEventListener('click', function() {
                const confirmationText = document.getElementById('delete-all-confirmation').value;
                if (confirmationText === 'DELETE ALL') {
                    deleteAllRecords();
                } else {
                    showMessage('กรุณาพิมพ์ "DELETE ALL" ให้ถูกต้อง', 'error');
                }
            });
            
            document.getElementById('cancel-delete-all').addEventListener('click', closeDeleteAllModal);
            
            document.getElementById('delete-all-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeleteAllModal();
                }
            });
        });
    </script>
</body>
</html>
